<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCAE System (Hierarchical)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js"></script>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col font-sans overflow-hidden">

    <div id="app" class="flex-1 flex flex-col h-full relative">
        <!-- HEADER -->
        <header class="bg-blue-900 text-white p-3 shadow-md flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold"><i class="fas fa-book"></i></div>
                <div><h1 class="font-bold leading-tight">NCAE System</h1><p class="text-[10px] text-yellow-300 font-mono" id="status-indicator">Initializing...</p></div>
            </div>
            <button id="btn-logout" class="hidden text-xs bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-white transition">Logout</button>
        </header>

        <!-- VIEW 1: LANDING -->
        <div id="view-landing" class="flex-1 flex items-center justify-center p-4 fade-in">
            <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8 text-center space-y-6">
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 text-3xl mx-auto"><i class="fas fa-user-graduate"></i></div>
                <h2 class="text-xl font-bold">Select Portal</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button id="nav-student" class="p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-500 transition"><i class="fas fa-user text-2xl text-blue-500 mb-2"></i><div class="font-bold text-sm">Student</div></button>
                    <button id="nav-teacher" class="p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-500 transition"><i class="fas fa-chalkboard-teacher text-2xl text-orange-500 mb-2"></i><div class="font-bold text-sm">Teacher</div></button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: TEACHER LOGIN -->
        <div id="view-teacher-login" class="hidden flex-1 flex items-center justify-center p-4 fade-in">
            <div class="max-w-sm w-full bg-white rounded-xl shadow-lg p-6 relative">
                <button id="close-login" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
                <div id="form-login">
                    <h2 class="text-lg font-bold mb-4">Teacher Login</h2>
                    <button id="do-google-login" class="w-full bg-white border border-slate-300 text-slate-700 font-bold py-3 rounded mb-4 hover:bg-slate-50 flex items-center justify-center gap-2 shadow-sm"><i class="fab fa-google text-red-500"></i> Sign in with Google</button>
                    <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink-0 mx-4 text-gray-400 text-xs">OR EMAIL</span><div class="flex-grow border-t border-gray-300"></div></div>
                    <input type="text" id="login-user" class="w-full p-3 border rounded mb-3 text-sm" placeholder="Username">
                    <input type="password" id="login-pass" class="w-full p-3 border rounded mb-4 text-sm" placeholder="Password">
                    <button id="do-login" class="w-full bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800 disabled:opacity-50">Login</button>
                    <div class="text-center mt-4 text-xs">New? <button id="show-register" class="text-blue-600 font-bold">Create Account</button></div>
                </div>
                
                <div id="form-register" class="hidden">
                    <h2 class="text-lg font-bold mb-1">Create Account</h2>
                    <p class="text-xs text-slate-500 mb-4">Account setup.</p>
                    <input type="text" id="reg-name" class="w-full p-2 border rounded mb-2 text-sm" placeholder="Full Name">
                    <input type="text" id="reg-user" class="w-full p-2 border rounded mb-2 text-sm" placeholder="Username">
                    <input type="password" id="reg-pass" class="w-full p-2 border rounded mb-4 text-sm" placeholder="Password">
                    <button id="do-register" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 disabled:opacity-50">Register</button>
                    <div class="text-center mt-4 text-xs"><button id="cancel-register" class="text-slate-500">Cancel</button></div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: DASHBOARD -->
        <div id="view-dashboard" class="hidden flex-1 flex overflow-hidden fade-in bg-slate-50">
            <aside class="w-64 bg-white border-r flex flex-col z-10 hidden md:flex">
                <div class="p-4 border-b">
                    <div class="font-bold truncate" id="dash-name">Teacher</div>
                    <div class="text-xs text-slate-500 truncate" id="dash-details">--</div>
                    <div class="text-xs text-green-600 flex items-center gap-1 mt-1"><i class="fas fa-circle text-[8px]"></i> Online</div>
                </div>
                <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
                    <button id="tab-btn-curriculum" class="w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-sm font-medium"><i class="fas fa-book w-6 text-slate-400"></i> Curriculum</button>
                    <button id="tab-btn-manage" class="w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-sm font-medium"><i class="fas fa-edit w-6 text-slate-400"></i> Manage Questions</button>
                    <button id="tab-btn-records" class="w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-sm font-medium"><i class="fas fa-users w-6 text-slate-400"></i> Student Records</button>
                    <button id="tab-btn-settings" class="w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-sm font-medium"><i class="fas fa-cog w-6 text-slate-400"></i> Account Settings</button>
                </nav>
                <div class="p-4 border-t"><button id="do-sync" class="w-full bg-blue-100 text-blue-800 text-xs font-bold py-2 rounded hover:bg-blue-200"><i class="fas fa-cloud-upload-alt mr-1"></i> Sync to Cloud</button></div>
            </aside>
            <main class="flex-1 overflow-y-auto custom-scroll p-4 relative">
                <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="md:hidden absolute top-4 left-4 z-20 bg-white p-2 rounded shadow text-slate-600"><i class="fas fa-bars"></i></button>

                <!-- TAB: CURRICULUM -->
                <div id="tab-curriculum" class="tab-content h-full p-2">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 pl-12 md:pl-0">Curriculum Setup</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                        <!-- 1. Grade Level -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <h3 class="font-bold text-sm mb-2 text-blue-900">1. Grade Level</h3>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="new-grade" class="flex-1 p-2 border rounded text-sm" placeholder="e.g. Grade 7">
                                <button id="do-add-grade" class="bg-blue-600 text-white px-3 rounded text-sm font-bold">+</button>
                            </div>
                            <div id="list-grade" class="space-y-1 max-h-40 overflow-y-auto"></div>
                        </div>

                        <!-- 2. Quarter/Semester -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <h3 class="font-bold text-sm mb-2 text-orange-700">2. Quarter / Sem</h3>
                            <select id="cur-grade-select" class="w-full p-2 border rounded text-sm mb-2 bg-slate-50"></select>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="new-quarter" class="flex-1 p-2 border rounded text-sm" placeholder="e.g. 1st Quarter">
                                <button id="do-add-quarter" class="bg-orange-500 text-white px-3 rounded text-sm font-bold">+</button>
                            </div>
                            <div id="list-quarter" class="space-y-1 max-h-40 overflow-y-auto"></div>
                        </div>

                        <!-- 3. Subject -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <h3 class="font-bold text-sm mb-2 text-green-700">3. Subject</h3>
                            <div class="flex gap-2 mb-2">
                                <select id="cur-quarter-select" class="flex-1 p-2 border rounded text-sm bg-slate-50"></select>
                            </div>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="new-subject" class="flex-1 p-2 border rounded text-sm" placeholder="e.g. Math">
                                <button id="do-add-subject" class="bg-green-600 text-white px-3 rounded text-sm font-bold">+</button>
                            </div>
                            <div id="list-subject" class="space-y-1 max-h-40 overflow-y-auto"></div>
                        </div>
                    </div>

                    <!-- 4. Create Course (Student Grouping) -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-sm mb-2 text-slate-700">4. Create Student Course (Section/Group)</h3>
                        <p class="text-xs text-slate-400 mb-2">Select subjects from the hierarchy above to include in this course.</p>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-course" class="flex-1 p-2 border rounded text-sm" placeholder="E.g., Grade 7 - Section A">
                            <button id="do-add-course" class="bg-slate-700 text-white px-4 rounded text-sm font-bold">Save</button>
                        </div>
                        <div id="chk-subjects" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4 text-xs bg-slate-50 p-2 rounded max-h-60 overflow-y-auto"></div>
                        <div id="list-course" class="space-y-1"></div>
                    </div>
                </div>

                <!-- TAB: QUESTIONS -->
                <div id="tab-manage" class="hidden tab-content h-full p-2">
                    <div class="flex justify-between items-center mb-4 pl-12 md:pl-0">
                        <h2 class="text-xl font-bold">Manage Questions</h2>
                        <div class="flex gap-2"><input type="file" id="docx-upload" class="hidden" accept=".docx"><button onclick="document.getElementById('docx-upload').click()" class="bg-blue-600 text-white text-xs px-3 py-2 rounded font-bold shadow hover:bg-blue-700"><i class="fas fa-file-word mr-1"></i> Import .DOCX</button></div>
                    </div>
                    
                    <!-- 3-LEVEL FILTER -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border mb-4 grid grid-cols-3 gap-4">
                        <div><label class="text-[10px] uppercase font-bold text-slate-400">1. Grade</label><select id="sel-grade" class="w-full p-2 border rounded bg-slate-50 text-sm"></select></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-400">2. Period</label><select id="sel-quarter" class="w-full p-2 border rounded bg-slate-50 text-sm"></select></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-400">3. Subject</label><select id="sel-subject" class="w-full p-2 border rounded bg-slate-50 text-sm"></select></div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 h-[calc(100%-150px)]">
                        <div class="w-full md:w-1/3 bg-white p-4 rounded border overflow-y-auto">
                            <h3 class="font-bold text-sm mb-2">Manual Entry</h3>
                            <textarea id="q-text" class="w-full p-2 border rounded text-sm mb-2 h-20" placeholder="Question Text"></textarea>
                            <div class="space-y-1 mb-2"><input id="opt-a" class="w-full p-1 border rounded text-xs" placeholder="Option A"><input id="opt-b" class="w-full p-1 border rounded text-xs" placeholder="Option B"><input id="opt-c" class="w-full p-1 border rounded text-xs" placeholder="Option C"><input id="opt-d" class="w-full p-1 border rounded text-xs" placeholder="Option D"></div>
                            <select id="correct-opt" class="w-full p-1 border rounded text-sm mb-2"><option value="A">Answer: A</option><option value="B">Answer: B</option><option value="C">Answer: C</option><option value="D">Answer: D</option></select>
                            <button id="do-save-manual" class="w-full bg-green-600 text-white py-1 rounded text-sm font-bold">Save Question</button>
                        </div>
                        <div class="flex-1 bg-white rounded border overflow-hidden flex flex-col">
                            <div id="q-list" class="flex-1 overflow-y-auto custom-scroll"></div>
                            <div id="q-empty" class="p-10 text-center text-slate-400 text-sm">Select Grade, Period, and Subject</div>
                        </div>
                    </div>
                </div>

                <!-- TAB: RECORDS -->
                <div id="tab-records" class="hidden tab-content h-full p-2">
                    <h2 class="text-xl font-bold mb-4 pl-12 md:pl-0">Student Records</h2>
                    <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                        <table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-3">Name</th><th class="p-3">Course</th><th class="p-3">Score</th><th class="p-3">Date</th></tr></thead><tbody id="table-records"></tbody></table>
                    </div>
                </div>

                <!-- TAB: SETTINGS -->
                <div id="tab-settings" class="hidden tab-content h-full p-2">
                    <h2 class="text-xl font-bold mb-4 pl-12 md:pl-0">Account Settings</h2>
                    <div class="max-w-md bg-white p-6 rounded-lg shadow-sm border">
                        <div class="mb-4">
                            <label class="text-xs font-bold text-slate-500 uppercase">Full Name</label>
                            <input type="text" id="set-name" class="w-full p-2 border rounded mt-1">
                        </div>
                        <div class="mb-4">
                            <label class="text-xs font-bold text-slate-500 uppercase">Grade Handled</label>
                            <input type="text" id="set-grade" class="w-full p-2 border rounded mt-1" placeholder="e.g. Grade 10">
                        </div>
                        <div class="mb-6">
                            <label class="text-xs font-bold text-slate-500 uppercase">Subject Handled</label>
                            <input type="text" id="set-subject" class="w-full p-2 border rounded mt-1" placeholder="e.g. Science">
                        </div>
                        <button id="do-save-profile" class="w-full bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800">Update Profile</button>
                    </div>
                </div>

            </main>
        </div>

        <!-- VIEW 4: STUDENT LOGIN -->
        <div id="view-student-login" class="hidden flex-1 flex items-center justify-center p-4 fade-in bg-slate-50">
            <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-6 relative">
                <button id="close-student" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
                <h2 class="text-lg font-bold mb-4">Student Access</h2>
                <div class="space-y-3">
                    <input type="text" id="st-name" class="w-full p-3 border rounded text-sm" placeholder="Full Name">
                    <input type="text" id="st-lrn" class="w-full p-3 border rounded text-sm" placeholder="LRN Number">
                    <select id="st-course" class="w-full p-3 border rounded text-sm bg-white"></select>
                    <button id="do-start-exam" class="w-full bg-blue-600 text-white font-bold py-3 rounded mt-2 hover:bg-blue-700">Start Exam</button>
                </div>
            </div>
        </div>

        <!-- VIEW 5: EXAM PORTAL -->
        <div id="view-exam" class="hidden flex-1 flex flex-col bg-white fade-in">
            <header class="p-4 border-b flex justify-between items-center bg-slate-50"><div><h1 class="font-bold">Exam Portal</h1><p class="text-xs text-slate-500" id="exam-student-info">--</p></div><div class="font-mono font-bold text-xl" id="timer">00:00</div></header>
            <main class="flex-1 flex flex-col items-center justify-center p-6 overflow-y-auto"><div class="max-w-2xl w-full"><div class="mb-6"><span class="text-[10px] font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded" id="exam-tag">SUBJ</span><h2 class="text-lg font-medium mt-2" id="exam-q-text">Loading...</h2></div><div class="space-y-3" id="exam-opts"></div><div class="mt-8 flex justify-between items-center"><span class="text-xs text-slate-400" id="exam-progress">1 / 10</span><button id="do-next-q" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Next</button></div></div></main>
        </div>
    </div>

    <!-- MODULE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7Sa9kkTFLF_cHS00DPzo8l847awBkBms",
            authDomain: "ncae-exam.firebaseapp.com",
            projectId: "ncae-exam",
            storageBucket: "ncae-exam.firebasestorage.app",
            messagingSenderId: "560276612754",
            appId: "1:560276612754:web:29169fa8f0d4752c28284b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const statusEl = document.getElementById('status-indicator');
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Cloud Ready';
        statusEl.classList.remove('text-yellow-300');
        statusEl.classList.add('text-green-400');

        let state = { user: null, data: {}, courses: {}, records: [], session: { q: [], a: {}, idx: 0, student: {} } };

        // --- 1. DEFINITIONS ---
        
        async function fetchData() {
            if(!state.user) return;
            try {
                const snap = await getDoc(doc(db,"teachers",state.user.uid));
                if(snap.exists()) {
                    const d = snap.data();
                    state.data = d.examData ? JSON.parse(d.examData) : {};
                    state.courses = d.courses ? JSON.parse(d.courses) : {};
                    state.records = d.records ? JSON.parse(d.records) : [];
                    
                    const dName = d.fullName || state.user.displayName || "Teacher";
                    document.getElementById('dash-name').innerText = dName;
                    
                    document.getElementById('set-name').value = dName;
                    document.getElementById('set-grade').value = d.gradeHandled || "";
                    document.getElementById('set-subject').value = d.subjectHandled || "";
                    
                    if(d.gradeHandled || d.subjectHandled) {
                        document.getElementById('dash-details').innerText = `${d.gradeHandled || ''} â€¢ ${d.subjectHandled || ''}`;
                    } else {
                        document.getElementById('dash-details').innerText = "Please update settings";
                    }

                    refreshCurriculumUI();
                    renderManageQuestionsUI();
                }
            } catch(e){console.error(e);}
        }

        async function syncCloud() {
            if(!state.user) return;
            const p = {
                examData: JSON.stringify(state.data),
                courses: JSON.stringify(state.courses),
                records: JSON.stringify(state.records),
                lastSync: new Date().toISOString()
            };
            await setDoc(doc(db,"teachers",state.user.uid), p, {merge:true});
        }

        async function saveProfile() {
            if(!state.user) return;
            const n = document.getElementById('set-name').value;
            const g = document.getElementById('set-grade').value;
            const s = document.getElementById('set-subject').value;
            try {
                await setDoc(doc(db,"teachers",state.user.uid), { fullName: n, gradeHandled: g, subjectHandled: s }, {merge:true});
                alert("Profile Updated!"); fetchData(); 
            } catch(e) { alert("Error: "+e.message); }
        }

        function login() {
            const u = document.getElementById('login-user').value + "@ncae.com", p = document.getElementById('login-pass').value;
            signInWithEmailAndPassword(auth, u, p).then(()=>setMode('dashboard')).catch(e=>alert(e.message));
        }
        function register() {
            const n = document.getElementById('reg-name').value, u = document.getElementById('reg-user').value + "@ncae.com", p = document.getElementById('reg-pass').value;
            createUserWithEmailAndPassword(auth, u, p).then(c => {
                return setDoc(doc(db, "teachers", c.user.uid), { fullName: n, username: document.getElementById('reg-user').value, examData: "{}", courses: "{}", records: "[]" });
            }).then(()=> { alert("Registered!"); setMode('dashboard'); }).catch(e=>alert(e.message));
        }

        // --- NEW DATA HIERARCHY: Grade -> Quarter -> Subject ---

        function refreshCurriculumUI() {
            renderGradeList();
            updateCurGradeSelect(); // Updates quarter dropdown logic
            // Subject list updates when quarter is selected
            renderCourseList();
            renderAllSubjectsCheckbox();
        }

        function addGrade() {
            const n = document.getElementById('new-grade').value;
            if(n && !state.data[n]) { state.data[n] = {}; syncCloud(); refreshCurriculumUI(); document.getElementById('new-grade').value=""; }
        }
        function addQuarter() {
            const g = document.getElementById('cur-grade-select').value;
            const n = document.getElementById('new-quarter').value;
            if(g && n && !state.data[g][n]) { state.data[g][n] = {}; syncCloud(); renderQuarterList(); updateCurQuarterSelect(); document.getElementById('new-quarter').value=""; }
            else { alert("Select Grade & Enter Quarter"); }
        }
        function addSubject() {
            const g = document.getElementById('cur-grade-select').value;
            const q = document.getElementById('cur-quarter-select').value;
            const n = document.getElementById('new-subject').value;
            if(g && q && n && !state.data[g][q][n]) { state.data[g][q][n] = []; syncCloud(); renderSubjectList(); document.getElementById('new-subject').value=""; renderAllSubjectsCheckbox(); }
            else { alert("Select Grade, Quarter & Enter Subject"); }
        }

        function delGrade(g) { 
            if(confirm("Delete Grade: " + g + "?")) { 
                delete state.data[g]; syncCloud(); refreshCurriculumUI(); 
            } 
        }
        function delQuarter(g, q) { 
            if(confirm("Delete Quarter: " + q + "?")) { 
                delete state.data[g][q]; syncCloud(); renderQuarterList(); updateCurQuarterSelect(); 
            } 
        }
        function delSubject(g, q, s) { 
            if(confirm("Delete Subject: " + s + "?")) { 
                delete state.data[g][q][s]; syncCloud(); renderSubjectList(); renderAllSubjectsCheckbox(); 
            } 
        }

        // Renderers with explicit event listeners
        function renderGradeList() {
            const d = document.getElementById('list-grade'); d.innerHTML="";
            Object.keys(state.data).forEach(k => {
                const row = document.createElement('div'); 
                row.className="flex justify-between items-center text-sm p-1 hover:bg-slate-50";
                
                const span = document.createElement('span');
                span.textContent = k;
                
                const btn = document.createElement('button');
                btn.className = "text-red-400 hover:text-red-600";
                btn.innerHTML = '<i class="fas fa-trash"></i>';
                btn.onclick = () => delGrade(k); // Closure captures 'k' correctly
                
                row.appendChild(span);
                row.appendChild(btn);
                d.appendChild(row);
            });
        }
        
        function updateCurGradeSelect() {
            const s = document.getElementById('cur-grade-select');
            s.innerHTML = "<option value=''>Select Grade</option>" + Object.keys(state.data).map(k=>`<option value="${k}">${k}</option>`).join('');
            s.onchange = () => { renderQuarterList(); updateCurQuarterSelect(); };
        }
        
        function renderQuarterList() {
            const g = document.getElementById('cur-grade-select').value;
            const d = document.getElementById('list-quarter'); d.innerHTML="";
            if(g && state.data[g]) {
                Object.keys(state.data[g]).forEach(k => {
                    const row = document.createElement('div'); 
                    row.className="flex justify-between items-center text-sm p-1 hover:bg-slate-50";
                    
                    const span = document.createElement('span');
                    span.textContent = k;
                    
                    const btn = document.createElement('button');
                    btn.className = "text-red-400 hover:text-red-600";
                    btn.innerHTML = '<i class="fas fa-trash"></i>';
                    btn.onclick = () => delQuarter(g, k);
                    
                    row.appendChild(span);
                    row.appendChild(btn);
                    d.appendChild(row);
                });
            }
        }
        
        function updateCurQuarterSelect() {
            const g = document.getElementById('cur-grade-select').value;
            const s = document.getElementById('cur-quarter-select');
            s.innerHTML = "<option value=''>Select Quarter</option>";
            if(g && state.data[g]) Object.keys(state.data[g]).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`);
            s.onchange = renderSubjectList;
        }
        
        function renderSubjectList() {
            const g = document.getElementById('cur-grade-select').value;
            const q = document.getElementById('cur-quarter-select').value;
            const d = document.getElementById('list-subject'); d.innerHTML="";
            if(g && q && state.data[g][q]) {
                Object.keys(state.data[g][q]).forEach(k => {
                    const row = document.createElement('div'); 
                    row.className="flex justify-between items-center text-sm p-1 hover:bg-slate-50";
                    
                    const span = document.createElement('span');
                    span.textContent = k;
                    
                    const btn = document.createElement('button');
                    btn.className = "text-red-400 hover:text-red-600";
                    btn.innerHTML = '<i class="fas fa-trash"></i>';
                    btn.onclick = () => delSubject(g, q, k);
                    
                    row.appendChild(span);
                    row.appendChild(btn);
                    d.appendChild(row);
                });
            }
        }

        // --- MANAGE QUESTIONS LOGIC ---
        function renderManageQuestionsUI() {
            const s = document.getElementById('sel-grade');
            s.innerHTML = "<option value=''>Select Grade</option>" + Object.keys(state.data).map(k=>`<option value="${k}">${k}</option>`).join('');
            s.onchange = updateManageQuarter;
        }
        function updateManageQuarter() {
            const g = document.getElementById('sel-grade').value;
            const s = document.getElementById('sel-quarter');
            s.innerHTML = "<option value=''>Select Period</option>";
            if(g && state.data[g]) Object.keys(state.data[g]).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`);
            s.onchange = updateManageSubject;
        }
        function updateManageSubject() {
            const g = document.getElementById('sel-grade').value;
            const q = document.getElementById('sel-quarter').value;
            const s = document.getElementById('sel-subject');
            s.innerHTML = "<option value=''>Select Subject</option>";
            if(g && q && state.data[g][q]) Object.keys(state.data[g][q]).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`);
            s.onchange = renderQuestions;
        }

        function saveManualQ() {
            const g = document.getElementById('sel-grade').value;
            const q = document.getElementById('sel-quarter').value;
            const s = document.getElementById('sel-subject').value;
            if(!g||!q||!s) return alert("Select all filters");
            const t=document.getElementById('q-text').value, a=document.getElementById('opt-a').value, b=document.getElementById('opt-b').value;
            if(!t || !a) return alert("Fill fields");
            state.data[g][q][s].push({ text:t, options:{A:a,B:b,C:document.getElementById('opt-c').value,D:document.getElementById('opt-d').value}, correct:document.getElementById('correct-opt').value });
            syncCloud(); renderQuestions(); document.getElementById('q-text').value="";
        }

        function renderQuestions() {
            const g=document.getElementById('sel-grade').value, q=document.getElementById('sel-quarter').value, s=document.getElementById('sel-subject').value;
            const l=document.getElementById('q-list'); l.innerHTML="";
            if(!g||!q||!s||!state.data[g][q][s]) { document.getElementById('q-empty').classList.remove('hidden'); return; }
            document.getElementById('q-empty').classList.add('hidden');
            state.data[g][q][s].forEach((item,i)=>{
                const btn = document.createElement('button'); btn.className="text-red-500 ml-auto"; btn.innerHTML="<i class='fas fa-trash'></i>";
                btn.onclick = () => { if(confirm("Del?")){ state.data[g][q][s].splice(i,1); syncCloud(); renderQuestions(); }};
                const r = document.createElement('div'); r.className="p-3 border-b flex gap-2";
                r.innerHTML=`<div><span class="font-bold">${i+1}.</span> ${item.text}</div>`; r.appendChild(btn); l.appendChild(r);
            });
        }

        function importDocx(inp) {
            const g=document.getElementById('sel-grade').value, q=document.getElementById('sel-quarter').value, s=document.getElementById('sel-subject').value;
            if(!g||!q||!s) return alert("Select Grade, Period & Subject first");
            mammoth.extractRawText({arrayBuffer: inp.files[0]}).then(r=>{
                const lines = r.value.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
                const qs=[]; let curr=null;
                lines.forEach(l=>{
                    if(l.match(/^(\d+[\.\)]|Q\d+)\s*(.+)/i)){ if(curr) qs.push(curr); curr={text:RegExp.$2,options:{},correct:'A'}; }
                    else if(l.match(/^([A-D])[\.\)]\s*(.+)/i) && curr) curr.options[RegExp.$1]=RegExp.$2;
                    else if(l.match(/^(?:Ans|Answer).*([A-D])/i) && curr) curr.correct=RegExp.$1;
                });
                if(curr) qs.push(curr);
                state.data[g][q][s].push(...qs); syncCloud(); alert("Imported "+qs.length); renderQuestions();
            });
        }

        // --- COURSE LOGIC (Flat Selection from Hierarchy) ---
        function renderAllSubjectsCheckbox() {
            const c = document.getElementById('chk-subjects'); c.innerHTML="";
            Object.keys(state.data).forEach(grade => {
                Object.keys(state.data[grade]).forEach(quart => {
                    Object.keys(state.data[grade][quart]).forEach(subj => {
                        const val = `${grade} > ${quart} > ${subj}`;
                        c.innerHTML += `<label class="flex items-center gap-1 p-1 hover:bg-white rounded"><input type="checkbox" value="${val}" class="c-chk"> ${grade}-${quart}-${subj}</label>`;
                    });
                });
            });
        }
        function addCourse() {
            const n = document.getElementById('new-course').value;
            if(!n) return;
            state.courses[n] = Array.from(document.querySelectorAll('.c-chk:checked')).map(x=>x.value);
            syncCloud(); renderCourseList(); document.getElementById('new-course').value="";
        }
        
        function renderCourseList() {
            const d=document.getElementById('list-course'); d.innerHTML="";
            Object.keys(state.courses).forEach(k=>{
                const div=document.createElement('div'); div.className="p-2 border rounded bg-slate-50 flex justify-between items-center";
                
                const span = document.createElement('span');
                span.className = "font-bold text-sm";
                span.textContent = k;
                
                const btn = document.createElement('button');
                btn.className = "text-red-400 hover:text-red-600";
                btn.innerHTML = '<i class="fas fa-trash"></i>';
                btn.onclick = () => { if(confirm("Delete Course " + k + "?")){ delete state.courses[k]; syncCloud(); renderCourseList(); }};
                
                div.appendChild(span);
                div.appendChild(btn);
                d.appendChild(div);
            });
        }

        // --- EXAM ---
        function renderStudentDropdown() { const s=document.getElementById('st-course'); s.innerHTML="<option value=''>Select Course</option>"; Object.keys(state.courses).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`); }
        function startExam() {
            const n = document.getElementById('st-name').value, c = document.getElementById('st-course').value;
            if(!n||!c) return alert("Required");
            state.session = { student:{name:n,course:c,lrn:document.getElementById('st-lrn').value}, q:[], a:{}, idx:0 };
            
            // Flatten questions based on selection string "Grade > Q > Subj"
            (state.courses[c]||[]).forEach(pathStr => {
                const [g, q, s] = pathStr.split(' > ');
                if(state.data[g] && state.data[g][q] && state.data[g][q][s]) {
                    state.data[g][q][s].forEach(quest => state.session.q.push({...quest, tag: s}));
                }
            });

            if(state.session.q.length===0) return alert("No Qs");
            setMode('exam'); renderExamQ();
        }
        function renderExamQ() {
            const q=state.session.q[state.session.idx]; document.getElementById('exam-q-text').innerText=q.text;
            document.getElementById('exam-tag').innerText = q.tag;
            const d=document.getElementById('exam-opts'); d.innerHTML="";
            ['A','B','C','D'].forEach(o=>{ if(q.options[o]) { const sel=state.session.a[state.session.idx]===o?'bg-blue-100 border-blue-500':'border-slate-200'; d.innerHTML+=`<button class="w-full text-left p-3 border rounded ${sel}" onclick="window.app.ans('${o}')">${o}. ${q.options[o]}</button>`; }});
        }
        function ans(o) { state.session.a[state.session.idx]=o; renderExamQ(); }
        function nextQ() { 
            if(state.session.idx<state.session.q.length-1){state.session.idx++;renderExamQ();} 
            else if(confirm("Submit?")){
                let sc=0; state.session.q.forEach((q,i)=>{if(state.session.a[i]===q.correct)sc++});
                state.records.push({name:state.session.student.name, course:state.session.student.course, lrn:state.session.student.lrn, score:`${sc}/${state.session.q.length}`, date:new Date().toLocaleDateString()});
                syncCloud(); alert("Score: "+sc); setMode('landing');
            }
        }
        function renderRecords() { const t=document.getElementById('table-records'); t.innerHTML=""; state.records.forEach(r=>t.innerHTML+=`<tr class="border-b"><td class="p-3">${r.name}</td><td class="p-3">${r.course}</td><td class="p-3">${r.score}</td><td class="p-3">${r.date}</td></tr>`); }

        // --- BINDINGS ---
        const bind = (id, fn) => { const el = document.getElementById(id); if(el) el.addEventListener('click', fn); };
        const bindChange = (id, fn) => { const el = document.getElementById(id); if(el) el.addEventListener('change', fn); };

        bind('do-google-login', () => signInWithPopup(auth, googleProvider).then(r=>{ alert("Welcome "+r.user.displayName); setMode('dashboard'); }).catch(e=>alert(e.message)));
        bind('do-login', login);
        bind('do-register', register);
        bind('btn-logout', () => signOut(auth));
        bind('nav-teacher', () => setMode('teacher-login'));
        bind('nav-student', () => { setMode('student-login'); renderStudentDropdown(); });
        bind('show-register', () => toggleRegister(true));
        bind('cancel-register', () => toggleRegister(false));
        bind('close-login', () => setMode('landing'));
        bind('close-student', () => setMode('landing'));
        bind('tab-btn-curriculum', () => setTab('curriculum'));
        bind('tab-btn-manage', () => setTab('manage'));
        bind('tab-btn-records', () => setTab('records'));
        bind('tab-btn-settings', () => setTab('settings')); 
        bind('do-sync', syncCloud);
        bind('do-save-profile', saveProfile); 
        
        bind('do-add-grade', addGrade);
        bind('do-add-quarter', addQuarter);
        bind('do-add-subject', addSubject);
        bind('do-add-course', addCourse);
        bind('do-save-manual', saveManualQ);
        bindChange('docx-upload', (e) => importDocx(e.target));
        bind('do-start-exam', startExam);
        bind('do-next-q', nextQ);

        // --- EXPOSE ---
        window.app = { ans, nextQ, logout: () => signOut(auth), delGrade, delQuarter, delSubject };

        // --- HELPER ---
        function setMode(m) { document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hidden')); document.getElementById(`view-${m}`).classList.remove('hidden'); }
        function toggleRegister(s) { document.getElementById('form-login').classList.toggle('hidden', s); document.getElementById('form-register').classList.toggle('hidden', !s); }
        function setTab(t) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden'); if(t==='records') renderRecords(); }

        onAuthStateChanged(auth, u => {
            state.user = u;
            if(u) {
                statusEl.innerText = "Online: "+(u.email||u.displayName);
                document.getElementById('btn-logout').classList.remove('hidden');
                fetchData();
            } else {
                statusEl.innerText = "Offline";
                document.getElementById('btn-logout').classList.add('hidden');
                setMode('landing');
            }
        });
    </script>
</body>
</html>
