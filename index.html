<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LearnNovaLMS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2D3B45">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Lato"', 'sans-serif'] },
                    colors: {
                        canvas: { base: '#2D3B45', primary: '#0e1e24', accent: '#0374B5', danger: '#EE4D3D', success: '#00AC18', light: '#F5F5F5' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F5F5F5; color: #2D3B45; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #0374B5; }
        .nav-item.active { background: rgba(3, 116, 181, 0.1); color: #0374B5; border-right: 3px solid #0374B5; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        #global-nav { width: 84px; flex-shrink: 0; background-color: #2D3B45; display: flex; flex-direction: column; align-items: center; padding-top: 1rem; z-index: 50; }
        .nav-item { color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 0.75rem 0; cursor: pointer; transition: background 0.2s; position: relative; }
        .nav-item:hover { background-color: #fff; color: #2D3B45; }
        .nav-item.active { background-color: #fff; color: #0374B5; border-left: 4px solid #0374B5; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .nav-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }
        .course-card { transition: transform 0.2s, box-shadow 0.2s; }
        .course-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .course-header { height: 140px; background-size: cover; background-position: center; position: relative; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #E2E8F0; border: 1px solid #E2E8F0; }
        .cal-cell { background: white; min-height: 120px; padding: 0.5rem; position: relative; }
        .cal-cell.today { background: #F0F9FF; }
        .event-pill { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; items-center; gap: 4px; transition: opacity 0.2s; }
        .embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; margin-top: 10px; } 
        .embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        /* Module Builder */
        .module-block { border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #fff; position: relative; transition: all 0.2s; }
        .module-block:hover { border-color: #0374B5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .block-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; opacity: 0.6; transition: opacity 0.2s; }
        .module-block:hover .block-actions { opacity: 1; }
        .rich-toolbar { background: #f8fafc; padding: 6px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .rich-btn { padding: 4px 8px; border-radius: 4px; background: white; border: 1px solid #e2e8f0; font-size: 12px; font-weight: bold; color: #475569; }
        .rich-btn:hover { background: #e2e8f0; color: #0f172a; }
        .rich-content { min-height: 80px; padding: 10px; outline: none; }

        @media (max-width: 768px) {
            #main-layout { flex-direction: column; }
            #global-nav { width: 100%; height: 60px; flex-direction: row; padding: 0; justify-content: space-around; position: fixed; bottom: 0; }
            .nav-item { padding: 0.5rem; }
            .nav-label { display: none; }
            #content-area { padding-bottom: 80px; }
            .calendar-grid { display: flex; flex-direction: column; gap: 8px; border: none; background: transparent; }
            .cal-cell { min-height: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
            .cal-header-row { display: none; }
        }
        #loading-screen { position: fixed; inset: 0; background: #2D3B45; z-index: 9999; display: flex; justify-content: center; items-center; color: white; flex-direction: column; gap: 1rem; transition: opacity 0.5s; }
        #sync-status { position: fixed; bottom: 1rem; right: 1rem; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; z-index: 100; display: flex; items-center; gap: 0.5rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    </style>
</head>
<body class="h-screen overflow-hidden text-sm">

    <div id="loading-screen"><i class="fas fa-circle-notch fa-spin text-4xl"></i><p class="font-bold tracking-widest">CONNECTING...</p></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    <div id="sync-status"><i class="fas fa-save"></i> Saved</div>
    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500"></div>
    <div id="modal-portal" class="relative z-[60]"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- FIREBASE CONFIGURATION ---
let firebaseConfig, appId = 'schoollms-v1';
const userConfig = { apiKey: "AIzaSyAZhN6M2AOAi_9NGgHw-lU-vZDDBGyIEAY", authDomain: "schoollms-475c9.firebaseapp.com", projectId: "schoollms-475c9", storageBucket: "schoollms-475c9.firebasestorage.app", messagingSenderId: "123401573481", appId: "1:123401573481:web:ca5179b069919236797ef8" };
if (typeof __firebase_config !== 'undefined') { firebaseConfig = JSON.parse(__firebase_config); appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; } else { firebaseConfig = userConfig; }

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const dbStore = getFirestore(app);
const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data/school_system`;
const MASTER_DOC_ID = 'master_record';

// --- DATA STORE ---
const defaultData = {
    users: [
        { id: 'u1', name: 'Mrs. Anderson', role: 'teacher', username: 'teacher', password: '123', avatar: 'MA' },
        { id: 'u2', name: 'Juan Dela Cruz', role: 'student', username: 'student', password: '123', avatar: 'JD' },
        { id: 'u0', name: 'School Admin', role: 'admin', username: 'admin', password: '123', avatar: 'AD' } 
    ],
    subjects: [
        { id: 's1', name: 'Introduction to Physics', code: 'PHYS-101', teacherId: 'u1', students: ['u2'], color: '#0374B5', img: 'https://images.unsplash.com/photo-1636466497217-26a8cbeaf0aa?auto=format&fit=crop&w=600&q=80', introTitle: 'Welcome to Physics', introBody: 'Check the feed.', gradingWeights: { ww: 40, pt: 40, qa: 20 } }
    ],
    posts: [{ id: 'p1', courseId: 's1', authorId: 'u1', authorName: 'Mrs. Anderson', date: '2023-10-24T09:00', content: 'Welcome to class!', mediaType: 'text', isPinned: false }],
    globalPosts: [],
    activities: { 's1': [] },
    activitySubmissions: {},
    exams: { 's1': [] },
    examSubmissions: {},
    modules: { 's1': [] }
};

let db = defaultData, currentUser = null, currentView = 'login', currentCourseId = null, activeExamId = null, currentTab = 'home', calendarDate = new Date(), importedText = '', tempPostImage = null, tempTeacherImage = null, adminCourseFilter = 'all', selectedLoginRole = null, firebaseUser = null; 
// Module Builder State
let builderBlocks = [], editingModuleId = null;

async function initFirebase() {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                firebaseUser = user;
                onSnapshot(doc(dbStore, PUBLIC_DATA_PATH, MASTER_DOC_ID), (docSnap) => {
                    if (docSnap.exists()) {
                        db = docSnap.data();
                        if(!db.activities) db.activities = {};
                        if(!db.activitySubmissions) db.activitySubmissions = {};
                        if(!db.modules) db.modules = {};
                        db.subjects.forEach(s => { if(!s.gradingWeights) s.gradingWeights = { ww: 40, pt: 40, qa: 20 }; });
                        if (currentUser) render(); 
                    } else { setDoc(doc(dbStore, PUBLIC_DATA_PATH, MASTER_DOC_ID), defaultData); db = defaultData; }
                    const loader = document.getElementById('loading-screen');
                    if(loader) { loader.style.opacity = 0; setTimeout(() => loader.remove(), 500); document.getElementById('app').classList.remove('opacity-0'); }
                    if(!currentUser) render(); 
                });
            }
        });
    } catch (e) { console.error("Firebase Error:", e); }
}
async function saveDB() { if (firebaseUser) setDoc(doc(dbStore, PUBLIC_DATA_PATH, MASTER_DOC_ID), db); }
initFirebase();

const $ = (id) => document.getElementById(id);
window.$ = $;
const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
const showToast = (msg, type='info') => {
    const box = document.createElement('div');
    box.className = `px-4 py-3 rounded shadow-lg text-white font-bold transform transition-all duration-300 translate-y-4 pointer-events-auto ${type==='error'?'bg-canvas-danger':'bg-canvas-accent'}`;
    box.innerText = msg;
    $('toast-container').appendChild(box);
    setTimeout(()=>box.remove(), 3000);
};
const showConfirm = (message, onYes) => {
    const id = 'confirm-modal';
    renderModal(id, 'Confirm', `<div class="space-y-4"><p>${message}</p><div class="flex justify-end gap-2"><button onclick="closeModal('${id}')" class="px-4 py-2 border rounded">Cancel</button><button id="confirm-yes" class="px-4 py-2 bg-red-600 text-white rounded">Confirm</button></div></div>`);
    setTimeout(() => $('confirm-yes').onclick = () => { onYes(); closeModal(id); }, 50);
};
const renderAvatar = (user, size='w-8 h-8', text='text-xs') => {
    if (user?.avatar?.startsWith('data:') || user?.avatar?.startsWith('http')) return `<img src="${user.avatar}" class="${size} rounded-full object-cover border bg-white">`;
    return `<div class="${size} rounded-full bg-blue-100 text-blue-600 flex items-center justify-center ${text} font-bold border border-blue-200">${user?.name?.[0]||'?'}</div>`;
};

// --- ROUTER ---
function render() {
    const app = $('app'); if (!app) return; app.innerHTML = '';
    if(currentView === 'login') { renderLogin(app); } else {
        app.innerHTML = `<div id="main-layout" class="flex w-full h-full bg-[#F5F5F5]"><nav id="global-nav"><div class="mb-6 hidden md:block"><i class="fas fa-shapes text-3xl text-white"></i></div><div class="nav-item ${currentView==='dashboard'?'active':''}" onclick="goDashboard()"><i class="fas fa-tachometer-alt nav-icon"></i><span class="nav-label">Dashboard</span></div>${currentUser.role === 'admin' ? `<div class="nav-item ${currentView==='teachers_list'?'active':''}" onclick="goTeachersList()"><i class="fas fa-chalkboard-teacher nav-icon"></i><span class="nav-label">Teachers</span></div>` : ''}<div class="nav-item ${currentView==='courses_list' || currentView==='course' || currentView==='module_builder' || currentView==='exam-take' || currentView==='exam-review'?'active':''}" onclick="goCoursesList()"><i class="fas fa-book nav-icon"></i><span class="nav-label">Courses</span></div><div class="nav-item ${currentView==='calendar'?'active':''}" onclick="goCalendar()"><i class="fas fa-calendar-alt nav-icon"></i><span class="nav-label">Calendar</span></div><div class="nav-item ${currentView==='settings'?'active':''}" onclick="goSettings()"><i class="fas fa-cog nav-icon"></i><span class="nav-label">Settings</span></div><div class="mt-auto mb-4 nav-item" onclick="logout()"><i class="fas fa-sign-out-alt nav-icon text-gray-400"></i><span class="nav-label text-gray-400">Logout</span></div></nav><main id="content-area" class="flex-1 overflow-y-auto relative"><header class="bg-white border-b border-gray-300 h-16 flex items-center justify-between px-6 sticky top-0 z-40"><div class="flex items-center gap-2 text-canvas-base"><h2 class="font-bold text-lg uppercase tracking-wide" id="page-title">Dashboard</h2></div><div class="flex items-center gap-3"><span class="text-sm font-bold text-gray-600">${currentUser.name}</span>${renderAvatar(currentUser, 'w-8 h-8', 'text-xs')}</div></header><div id="page-content" class="p-6 md:p-8 max-w-7xl mx-auto"></div></main></div>`;
        const c = $('page-content');
        if(currentView === 'dashboard') renderDashboard(c);
        if(currentView === 'teachers_list') renderTeachersList(c);
        if(currentView === 'courses_list') renderCoursesList(c);
        if(currentView === 'calendar') renderCalendar(c);
        if(currentView === 'course') renderCourse(c);
        if(currentView === 'module_builder') renderModuleBuilder(c);
        if(currentView === 'exam-take') renderExamTake(c);
        if(currentView === 'exam-review') renderExamReview(c);
        if(currentView === 'settings') renderSettings(c);
    }
}

window.goDashboard = () => { currentView = 'dashboard'; render(); }
window.goTeachersList = () => { currentView = 'teachers_list'; render(); }
window.goCoursesList = () => { currentView = 'courses_list'; render(); }
window.goCalendar = () => { currentView = 'calendar'; render(); }
window.goSettings = () => { currentView = 'settings'; render(); }
window.logout = () => { currentUser = null; currentView = 'login'; selectedLoginRole = null; render(); }
window.render = render;

function renderLogin(c) {
    c.innerHTML = `<div class="flex h-screen w-full bg-[#2D3B45] items-center justify-center"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center"><i class="fas fa-shapes text-5xl text-canvas-accent mb-6 inline-block"></i><h1 class="text-3xl font-bold text-gray-800 mb-2">Learn Nova LMS</h1><p class="text-gray-500 mb-8" id="login-subtext">Select your portal to continue</p><div id="role-selector" class="space-y-4 animate-fade-in"><button onclick="showLoginForm('teacher')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm"><div class="bg-blue-100 text-blue-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition text-lg"><i class="fas fa-chalkboard-teacher"></i></div><div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Teacher Login</span><span class="text-xs text-gray-400">Faculty access & management</span></div></button><button onclick="showLoginForm('student')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm"><div class="bg-green-100 text-green-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition text-lg"><i class="fas fa-user-graduate"></i></div><div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Student Login</span><span class="text-xs text-gray-400">Access courses</span></div></button><button onclick="showLoginForm('admin')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm"><div class="bg-purple-100 text-purple-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition text-lg"><i class="fas fa-user-shield"></i></div><div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Admin Login</span><span class="text-xs text-gray-400">System config</span></div></button></div><div id="login-form-box" class="hidden text-left animate-fade-in"><div class="flex items-center mb-6"><button onclick="hideLoginForm()" class="text-gray-400 hover:text-gray-600 mr-3 p-2 rounded-full hover:bg-gray-100 transition"><i class="fas fa-arrow-left"></i></button><h2 class="text-xl font-bold text-gray-800" id="form-role-title">Login</h2></div><div class="space-y-4"><div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Username</label><input id="login-user" type="text" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:outline-none focus:border-canvas-accent transition"></div><div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Password</label><input id="login-pass" type="password" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:outline-none focus:border-canvas-accent transition"></div><button onclick="loginAttempt()" class="w-full bg-canvas-accent text-white font-bold py-3.5 rounded-lg hover:bg-blue-700 transition shadow-lg mt-2">Sign In</button></div></div></div></div>`;
}

window.showLoginForm = (role) => { selectedLoginRole = role; const titleMap = { 'teacher': 'Teacher Portal', 'student': 'Student Portal', 'admin': 'Administrator' }; $('role-selector').classList.add('hidden'); $('login-subtext').classList.add('hidden'); $('login-form-box').classList.remove('hidden'); $('form-role-title').innerText = titleMap[role]; setTimeout(() => $('login-user').focus(), 100); }
window.hideLoginForm = () => { selectedLoginRole = null; $('role-selector').classList.remove('hidden'); $('login-subtext').classList.remove('hidden'); $('login-form-box').classList.add('hidden'); $('login-user').value = ''; $('login-pass').value = ''; }
window.loginAttempt = () => { const u = $('login-user').value.toLowerCase().trim(); const p = $('login-pass').value.trim(); const user = db.users.find(x => x.username === u); if(user && user.password === p) { if (selectedLoginRole && user.role !== selectedLoginRole) { showToast(`This account is not a ${selectedLoginRole}.`, 'error'); return; } currentUser = user; goDashboard(); } else { showToast('Invalid Username or Password', 'error'); } }

function renderDashboard(c) {
    $('page-title').innerText = 'Dashboard';
    if(currentUser.role === 'admin') {
        c.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1"><div class="bg-white p-6 rounded shadow border border-gray-200 sticky top-4"><h3 class="font-bold text-lg mb-4 text-gray-800">Post Global Announcement</h3><div class="space-y-3"><input id="gp-title" class="w-full border p-2 rounded text-sm" placeholder="Title"><textarea id="gp-content" class="w-full border p-2 rounded text-sm h-24" placeholder="Announcement body..."></textarea><select id="gp-type" class="w-full border p-2 rounded text-sm bg-gray-50" onchange="toggleAdminMedia()"><option value="text">Text Only</option><option value="image_upload">Image (Upload Poster)</option><option value="image_url">Image (URL)</option><option value="video">Video (YouTube)</option></select><input id="gp-url" class="w-full border p-2 rounded text-sm hidden" placeholder="Media URL..."><div id="gp-file-container" class="hidden"><label class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"><input type="file" id="gp-file" accept="image/*" class="w-full"></label></div><button onclick="publishGlobalPost()" class="w-full bg-canvas-accent text-white py-2 rounded font-bold hover:bg-blue-700">Publish</button></div></div><div class="bg-white p-6 rounded shadow border border-gray-200 mt-6"><h3 class="font-bold text-lg mb-4 text-gray-800">Register Teacher</h3><div class="space-y-3"><input id="reg-t-name" class="w-full border p-2 rounded text-sm" placeholder="Full Name"><input id="reg-t-user" class="w-full border p-2 rounded text-sm" placeholder="Username"><input id="reg-t-pass" class="w-full border p-2 rounded text-sm" placeholder="Password"><button onclick="registerTeacher()" class="w-full bg-canvas-success text-white py-2 rounded font-bold">Create Account</button></div></div></div><div class="lg:col-span-2"><h3 class="font-bold text-gray-500 uppercase text-xs mb-4">Active Global Posts</h3><div class="space-y-6">${(db.globalPosts || []).length === 0 ? '<p class="text-gray-400">No active posts.</p>' : ''}${(db.globalPosts || []).map(p => renderPostCard(p, true)).join('')}</div></div></div>`;
        setTimeout(() => { const fileInput = document.getElementById('gp-file'); if(fileInput) { fileInput.addEventListener('change', function(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(evt) { tempPostImage = evt.target.result; }; reader.readAsDataURL(file); } }); } }, 500); return;
    }
    c.innerHTML = `<div class="max-w-4xl mx-auto"><div class="mb-4 flex items-center gap-2"><div class="bg-canvas-accent text-white p-2 rounded"><i class="fas fa-newspaper"></i></div><div><h2 class="text-2xl font-bold text-gray-800">School News & Announcements</h2><p class="text-gray-500 text-sm">Latest updates from the administration.</p></div></div><div class="space-y-6">${(db.globalPosts && db.globalPosts.length > 0) ? db.globalPosts.map(p => renderPostCard(p, false)).join('') : '<div class="bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-inbox text-4xl mb-3 block"></i>No announcements yet.</div>'}</div></div>`;
}

function renderTeachersList(c) {
    if(currentUser.role !== 'admin') return goDashboard();
    $('page-title').innerText = 'Teachers Directory';
    const teachers = db.users.filter(u => u.role === 'teacher').sort((a,b) => b.id.localeCompare(a.id));
    c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Registered Teachers (${teachers.length})</h3></div><div class="bg-white border rounded shadow-sm overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b"><tr><th class="p-4">Name</th><th class="p-4">Username</th><th class="p-4">Password</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr></thead><tbody class="divide-y divide-gray-100">${teachers.length === 0 ? '<tr><td colspan="5" class="p-4 text-center text-gray-400">No teachers found.</td></tr>' : ''}${teachers.map(t => `<tr class="hover:bg-gray-50"><td class="p-4 font-bold text-gray-800 flex items-center gap-3">${renderAvatar(t, 'w-8 h-8', 'text-xs')}${t.name}</td><td class="p-4 font-mono text-gray-600">${t.username}</td><td class="p-4 font-mono text-gray-400 text-xs">${t.password}</td><td class="p-4"><span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">Active</span></td><td class="p-4 text-right"><button onclick="deleteUser('${t.id}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody></table></div>`;
}

function renderSettings(c) {
    $('page-title').innerText = 'Account Settings';
    let html = `<div class="max-w-2xl mx-auto space-y-8"><div class="bg-white p-6 rounded shadow border border-gray-200"><h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Profile Picture</h3><div class="flex items-center gap-4"><div id="settings-avatar-preview">${renderAvatar(currentUser, 'w-16 h-16', 'text-2xl')}</div><div class="flex-1"><input type="file" id="profile-pic-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><p class="text-xs text-gray-400 mt-1">Recommended: Square JPG/PNG</p></div><button onclick="saveProfilePic()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm">Upload</button></div></div><div class="bg-white p-6 rounded shadow border border-gray-200"><h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Security</h3><div class="space-y-4"><div><label class="block text-sm font-bold text-gray-500 mb-1">New Password</label><input type="password" id="set-new-pass" class="w-full border p-2 rounded" placeholder="Enter new password"></div><button onclick="updatePassword()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm">Update Password</button></div></div>`;
    if(currentUser.role === 'teacher') {
        const myCourses = db.subjects.filter(s => s.teacherId === currentUser.id);
        html += `<div class="bg-white p-6 rounded shadow border border-gray-200"><h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">My Course Details</h3><div class="space-y-4">${myCourses.map(s => `<div class="border rounded p-4 bg-gray-50"><h4 class="font-bold text-canvas-accent mb-2">${s.name} (${s.code})</h4><div class="grid grid-cols-2 gap-2 mb-2"><input id="edit-name-${s.id}" value="${s.name}" class="border p-1 rounded text-sm" placeholder="Name"><input id="edit-code-${s.id}" value="${s.code}" class="border p-1 rounded text-sm" placeholder="Code"></div><input id="edit-intro-${s.id}" value="${s.introTitle || ''}" class="w-full border p-1 rounded text-sm mb-2" placeholder="Intro Title"><button onclick="updateCourseDetails('${s.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Save Changes</button></div>`).join('')}</div></div>`;
    }
    html += `</div>`;
    c.innerHTML = html;
}

// Global actions
window.deleteUser = (uid) => { showConfirm('Delete user?', () => { db.users = db.users.filter(u => u.id !== uid); saveDB(); render(); }); }
window.saveProfilePic = () => { const f=$('profile-pic-upload').files[0]; if(f){ const r=new FileReader(); r.onload=e=>{ const u=db.users.find(x=>x.id===currentUser.id); if(u){ u.avatar=e.target.result; saveDB(); render(); }}; r.readAsDataURL(f); } }
window.updatePassword = () => { const p=$('set-new-pass').value; if(p){ const u=db.users.find(x=>x.id===currentUser.id); u.password=p; saveDB(); showToast('Password updated'); } }
window.updateCourseDetails = (sid) => { const s=db.subjects.find(x=>x.id===sid); s.name=$(`edit-name-${sid}`).value; s.code=$(`edit-code-${sid}`).value; s.introTitle=$(`edit-intro-${sid}`).value; saveDB(); }
window.registerTeacher = () => { const n=$('reg-t-name').value, u=$('reg-t-user').value, p=$('reg-t-pass').value; if(n&&u&&p){ db.users.push({id:'u'+Date.now(), name:n, username:u, password:p, role:'teacher'}); saveDB(); render(); }}
window.registerStudent = () => { const n=$('reg-s-name').value, u=$('reg-s-user').value, p=$('reg-s-pass').value; if(n&&u&&p){ const newId='u'+Date.now(); db.users.push({id:newId, name:n, username:u, password:p, role:'student'}); if(currentCourseId){ const s=db.subjects.find(x=>x.id===currentCourseId); if(s)s.students.push(newId); } saveDB(); render(); closeModal('modal-reg-student'); }}

function renderCoursesList(c) {
    $('page-title').innerText = 'Courses';
    let subs = [];
    if (currentUser.role === 'admin') {
        const teachers = db.users.filter(u => u.role === 'teacher');
        let filterHtml = `<select onchange="setAdminFilter(this.value)" class="border p-2 rounded bg-white text-sm"><option value="all">All Teachers</option>${teachers.map(t => `<option value="${t.id}" ${adminCourseFilter===t.id?'selected':''}>${t.name}</option>`).join('')}</select>`;
        subs = adminCourseFilter === 'all' ? db.subjects : db.subjects.filter(s => s.teacherId === adminCourseFilter);
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3><div class="flex gap-2">${filterHtml}${currentUser.role==='teacher'?`<button onclick="openAddCourseModal()" class="bg-canvas-accent text-white px-4 py-2 rounded">New Course</button>`:''}</div></div>`;
    } else if (currentUser.role === 'teacher') {
        subs = db.subjects.filter(s => s.teacherId === currentUser.id);
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3><button onclick="openAddCourseModal()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm shadow hover:bg-blue-700 transition"><i class="fas fa-plus mr-2"></i>New Course</button></div>`;
    } else {
        subs = db.subjects.filter(s => s.students.includes(currentUser.id));
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3></div>`;
    }
    
    if(subs.length === 0) { c.innerHTML += `<div class="bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-book-open text-4xl mb-3 block"></i><p>No courses found.</p></div>`; }
    else {
        c.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${subs.map(s => {
            const t = db.users.find(u => u.id === s.teacherId);
            return `<div onclick="openCourse('${s.id}')" class="course-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-pointer h-64 flex flex-col group"><div class="course-header" style="background-image: url('${s.img}'); background-color: ${s.color}"><div class="absolute inset-0 bg-black/30 p-4 transition group-hover:bg-black/40"><span class="bg-white/90 text-xs font-bold px-2 py-1 rounded w-max text-gray-800 shadow-sm">${s.code}</span></div></div><div class="p-4 flex-1 flex flex-col justify-between"><div><h3 class="font-bold text-canvas-accent text-lg leading-tight mb-1 group-hover:underline">${s.name}</h3><p class="text-xs text-gray-500">${t ? t.name : 'Unknown Instructor'}</p></div><div class="flex items-center justify-between text-gray-400 text-sm"><span class="text-xs bg-gray-100 px-2 py-1 rounded">${s.students.length} Students</span></div></div></div>`;
        }).join('')}</div>`;
    }
}
window.setAdminFilter = (val) => { adminCourseFilter = val; render(); }
function renderPostCard(p, isAdmin) { let mediaHtml = ''; if(p.mediaType==='video'&&p.mediaUrl){let u=p.mediaUrl.replace('watch?v=','embed/'); mediaHtml=`<div class="embed-container mt-3"><iframe src="${u}" frameborder="0"></iframe></div>`;} else if((p.mediaType==='image_url'||p.mediaType==='image_upload')&&p.mediaUrl){mediaHtml=`<img src="${p.mediaUrl}" class="w-full h-auto rounded mt-3">`;} return `<div class="bg-white p-6 rounded border border-gray-200 shadow-sm relative group">${isAdmin?`<button onclick="deleteGlobalPost('${p.id}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>`:''}<div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 rounded-full bg-canvas-accent text-white flex items-center justify-center font-bold text-xs"><i class="fas fa-university"></i></div><div><h4 class="font-bold text-gray-800 text-lg">${p.title}</h4><p class="text-xs text-gray-500">Posted by Admin • ${new Date(p.date).toLocaleDateString()}</p></div></div><div class="text-gray-700 mt-2 whitespace-pre-line">${p.content}</div>${mediaHtml}</div>`; }
window.toggleAdminMedia = () => { const t=$('gp-type').value; $('gp-url').classList.toggle('hidden', t!=='image_url'&&t!=='video'); $('gp-file-container').classList.toggle('hidden', t!=='image_upload'); }
window.publishGlobalPost = () => { const t=$('gp-title').value, c=$('gp-content').value, type=$('gp-type').value; let u=$('gp-url').value; if(type==='image_upload') u=tempPostImage; if(t&&c){ if(!db.globalPosts) db.globalPosts=[]; db.globalPosts.unshift({id:'gp'+Date.now(), title:t, content:c, mediaType:type, mediaUrl:u, date:new Date().toISOString()}); tempPostImage=null; saveDB(); render(); }}
window.deleteGlobalPost = (id) => { showConfirm('Delete?', ()=>{ db.globalPosts=db.globalPosts.filter(p=>p.id!==id); saveDB(); render(); }); }
window.openAddCourseModal = () => { renderModal('modal-add-course', 'Add Course', `<div class="space-y-3"><input id="c-name" class="w-full border p-2 rounded" placeholder="Course Name"><input id="c-code" class="w-full border p-2 rounded" placeholder="Course Code"><div><label class="text-xs font-bold text-gray-500">Teacher</label><select id="c-teacher" class="w-full border p-2 rounded bg-white text-sm">${db.users.filter(u=>u.role==='teacher').map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}</select></div><button onclick="addCourse()" class="w-full bg-canvas-accent text-white py-2 rounded">Create</button></div>`); }
window.addCourse = () => { const n=$('c-name').value, c=$('c-code').value; let tid=currentUser.id; if(currentUser.role==='admin') tid=$('c-teacher').value; if(n&&c){ db.subjects.push({id:'s'+Date.now(), name:n, code:c, teacherId:tid, students:[], color:'#0374B5', img:'', introTitle:'Welcome', introBody:'', gradingWeights:{ww:40,pt:40,qa:20}}); saveDB(); render(); closeModal('modal-add-course'); }}
window.openCourse = (sid) => { currentCourseId = sid; currentView = 'course'; currentTab = 'home'; render(); }

function renderCalendar(c) {
    $('page-title').innerText = 'Calendar';
    const year=calendarDate.getFullYear(), month=calendarDate.getMonth(), firstDay=new Date(year,month,1).getDay(), days=new Date(year,month+1,0).getDate();
    let html = `<div class="bg-white p-4 rounded shadow mb-4 flex justify-between"><button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button><h2 class="font-bold text-xl">${calendarDate.toLocaleString('default',{month:'long'})} ${year}</h2><button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button></div><div class="calendar-grid">${['S','M','T','W','T','F','S'].map(d=>`<div class="bg-gray-50 p-2 text-center text-xs font-bold">${d}</div>`).join('')}`;
    for(let i=0;i<firstDay;i++) html+=`<div class="cal-cell bg-gray-50/50"></div>`;
    for(let d=1;d<=days;d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; let evts='';
        db.subjects.forEach(s => { if(currentUser.role==='student'&&!s.students.includes(currentUser.id)) return; if(currentUser.role==='teacher'&&s.teacherId!==currentUser.id) return; (db.exams[s.id]||[]).forEach(e=>{if(e.dueDate.startsWith(dateStr)) evts+=`<div class="event-pill" style="background:${s.color};color:white">Due: ${e.title}</div>`}); });
        html += `<div class="cal-cell">${d}<div class="flex flex-col gap-1 mt-1">${evts}</div></div>`;
    }
    html += `</div>`; c.innerHTML = html;
}
window.changeMonth = (d) => { calendarDate.setMonth(calendarDate.getMonth()+d); render(); }

function renderCourse(c) {
    const s = db.subjects.find(x => x.id === currentCourseId); if(!s) return goDashboard();
    $('page-title').innerHTML = `<span class="text-gray-400 cursor-pointer" onclick="goCoursesList()">${s.code}</span> <span class="mx-2">></span> ${s.name}`;
    c.innerHTML = `<div class="flex flex-col md:flex-row gap-6 h-full"><nav class="w-full md:w-48 flex-shrink-0 flex md:flex-col gap-1 text-sm font-medium text-canvas-primary border-r border-gray-200 pb-4 md:pr-4"><a onclick="switchCourseTab('home')" class="${currentTab==='home'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Home</a><a onclick="switchCourseTab('modules')" class="${currentTab==='modules'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Modules</a><a onclick="switchCourseTab('activities')" class="${currentTab==='activities'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Activities</a><a onclick="switchCourseTab('quizzes')" class="${currentTab==='quizzes'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Quizzes/Exams</a><a onclick="switchCourseTab('grades')" class="${currentTab==='grades'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Grades</a><a onclick="switchCourseTab('people')" class="${currentTab==='people'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">People</a></nav><div id="course-content" class="flex-1"></div></div>`;
    renderCourseTab();
}
window.switchCourseTab = (t) => { currentTab=t; render(); }

function renderCourseTab() {
    const c = $('course-content'), s = db.subjects.find(x => x.id === currentCourseId), isTeacher = currentUser.role === 'teacher' || currentUser.role === 'admin';
    if(currentTab === 'home') {
        const posts = (db.posts||[]).filter(p=>p.courseId===s.id).sort((a,b)=>new Date(b.date)-new Date(a.date));
        c.innerHTML = `<div class="bg-white p-6 rounded border border-gray-200 mb-6 relative group">${isTeacher ? `<button onclick="editIntro()" class="absolute top-4 right-4 text-gray-400 hover:text-canvas-accent"><i class="fas fa-edit"></i> Edit Info</button>` : ''}<h2 class="text-2xl font-bold text-gray-800 mb-2">${s.introTitle||`Welcome`}</h2><p class="text-gray-600 leading-relaxed">${s.introBody||'No info.'}</p></div>${isTeacher?`<div class="bg-white p-4 rounded border border-gray-200 mb-6 shadow-sm"><textarea id="post-content" class="w-full border p-3 rounded mb-2 text-sm" placeholder="Share announcement..." rows="3"></textarea><div class="flex flex-col gap-2"><div class="flex gap-2"><select id="post-type" class="border p-2 rounded text-sm bg-gray-50 flex-1" onchange="toggleMediaInput()"><option value="text">Text Only</option><option value="link">Link</option><option value="video">Video</option><option value="image_upload">Image (Upload)</option><option value="image_url">Image (URL)</option><option value="gif">GIF (URL)</option></select><button onclick="publishPost()" class="bg-canvas-accent text-white px-6 py-2 rounded font-bold">Post</button></div><input id="post-url" class="border p-2 rounded text-sm hidden" placeholder="Paste URL here..."><div id="post-file-container" class="hidden border border-dashed border-gray-300 p-2 rounded bg-gray-50"><input type="file" id="post-file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"></div></div></div>` : ''}<div class="space-y-6">${posts.map(p=>`<div class="bg-white p-6 rounded border border-gray-200 relative group ${p.isPinned ? 'bg-yellow-50 border-yellow-200' : ''}">${p.isPinned ? '<div class="absolute top-2 left-2 text-xs font-bold text-yellow-600"><i class="fas fa-thumbtack mr-1"></i> Pinned</div>' : ''}${isTeacher ? `<div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="togglePinPost('${p.id}')" class="${p.isPinned ? 'text-canvas-accent' : 'text-gray-300 hover:text-canvas-accent'}"><i class="fas fa-thumbtack"></i></button><button onclick="deletePost('${p.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div>` : ''}<div class="flex gap-3 mb-3 mt-4">${renderAvatar({name:p.authorName},'w-10 h-10')}<div><p class="font-bold text-sm">${p.authorName}</p><p class="text-xs text-gray-500">${new Date(p.date).toLocaleString()}</p></div></div><div class="text-gray-700 whitespace-pre-line">${p.content}</div></div>`).join('')}</div>`;
        setTimeout(() => { const fileInput = document.getElementById('post-file'); if(fileInput) { fileInput.addEventListener('change', function(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(evt) { tempTeacherImage = evt.target.result; }; reader.readAsDataURL(file); } }); } }, 500);
    }
    // --- MODULES TAB ---
    if(currentTab === 'modules') {
        const modules = db.modules[s.id] || [];
        c.innerHTML = `<div class="flex justify-between items-center mb-6 border-b pb-4"><div><h2 class="text-xl font-bold text-gray-800">Learning Modules</h2></div>${isTeacher ? `<button onclick="openModuleBuilder()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm"><i class="fas fa-plus mr-2"></i>Create Module</button>` : ''}</div><div class="space-y-4">${modules.map(m => `<div class="bg-white p-4 rounded border hover:shadow-md transition"><div class="flex justify-between items-center"><div class="cursor-pointer flex-1" onclick="viewModule('${m.id}')"><h3 class="font-bold text-lg text-canvas-primary">${m.title}</h3><p class="text-xs text-gray-500">${m.blocks.length} sections • Published ${new Date(m.date).toLocaleDateString()}</p></div>${isTeacher ? `<div class="flex gap-2"><button onclick="editModule('${m.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded"><i class="fas fa-edit"></i></button><button onclick="deleteModule('${m.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button></div>` : '<i class="fas fa-chevron-right text-gray-300"></i>'}</div></div>`).join('')}</div>${modules.length===0?'<div class="text-center py-10 text-gray-400 border border-dashed rounded">No modules yet.</div>':''}`;
    }
    
    // --- ACTIVITIES TAB (RESTORED) ---
    if(currentTab === 'activities') {
        const acts = db.activities[s.id] || [];
        let html = `<div class="flex justify-between items-center mb-6 border-b pb-4"><div><h2 class="text-xl font-bold text-gray-800">Class Activities</h2><p class="text-gray-500 text-xs">Performance Tasks & Written Work</p></div>${isTeacher ? `<button onclick="openActivityModal()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm shadow hover:bg-blue-700 transition"><i class="fas fa-plus mr-2"></i>New Activity</button>` : ''}</div>`;
        if(acts.length === 0) { html += `<div class="bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-clipboard-list text-4xl mb-3 block"></i>No activities yet.</div>`; } 
        else {
            html += `<div class="grid grid-cols-1 gap-4">`;
            acts.forEach(a => {
                const badgeColor = a.category === 'pt' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700';
                let statusText = `<span class="text-gray-400 text-xs"><i class="fas fa-clock"></i> Due: ${a.dueDate ? formatDate(a.dueDate) : 'None'}</span>`;
                if (!isTeacher) {
                    const sub = db.activitySubmissions[a.id]?.[currentUser.id];
                    let isSub = false; 
                    if(sub && (sub.submittedAt || typeof sub === 'number')) isSub = true; 
                    if(isSub) statusText = `<span class="text-green-600 text-xs font-bold"><i class="fas fa-check-circle"></i> Submitted</span>`;
                    else if(a.dueDate && new Date() > new Date(a.dueDate)) statusText = `<span class="text-red-500 text-xs font-bold"><i class="fas fa-exclamation-circle"></i> Missing</span>`;
                }
                html += `<div class="bg-white p-4 rounded border flex justify-between items-center hover:bg-gray-50 transition cursor-pointer" onclick="openActivityDetail('${a.id}')"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-clipboard-check text-xl"></i></div><div><h4 class="font-bold text-gray-800 text-lg">${a.title}</h4><div class="flex gap-2 text-xs mt-1 items-center"><span class="${badgeColor} px-2 py-0.5 rounded font-bold uppercase">${a.category==='pt'?'Perf Task':'Written'}</span><span class="text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Max: ${a.maxScore} pts</span>${statusText}</div></div></div>${isTeacher ? `<button onclick="event.stopPropagation(); deleteActivity('${a.id}')" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>` : '<i class="fas fa-chevron-right text-gray-300"></i>'}</div>`;
            });
            html += `</div>`;
        }
        c.innerHTML = html;
    }

    // --- QUIZZES TAB (RESTORED) ---
    if(currentTab === 'quizzes') {
        const exams = db.exams[s.id] || [];
        let html = `<div class="flex justify-between items-center mb-4 border-b pb-2"><div><h2 class="text-xl font-bold text-gray-800">Quizzes & Exams</h2><p class="text-xs text-gray-500">Auto-graded assessments</p></div>${isTeacher ? `<div class="flex gap-2"><button onclick="openImportModal()" class="bg-white border text-gray-700 px-3 py-1 rounded text-sm font-bold"><i class="fas fa-file-word"></i> Import DOCX</button><button onclick="openCreateModal()" class="bg-canvas-accent text-white px-3 py-1 rounded text-sm font-bold"><i class="fas fa-plus"></i> Manual</button></div>` : ''}</div><div class="space-y-3">${exams.map(e => {
            const sub = db.examSubmissions[e.id]?.[currentUser.id];
            const att = sub ? (sub.attemptsTaken || 0) : 0;
            const now = new Date(), open = new Date(e.openDate), due = new Date(e.dueDate);
            const isUpcoming = now < open, isClosed = now > due;
            let btn = '';
            if(isTeacher || currentUser.role==='admin') btn = `<div class="flex gap-2"><button onclick="showItemAnalysis('${e.id}')" class="text-xs bg-gray-100 px-2 py-1 rounded">Stats</button><button onclick="openCreateModal('${e.id}')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">Edit</button><button onclick="deleteExam('${e.id}')" class="text-red-500 px-2 py-1 rounded">Delete</button></div>`;
            else {
                if(isUpcoming) btn=`<span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded">Opens ${formatDate(e.openDate)}</span>`;
                else if(isClosed && !sub) btn=`<span class="text-xs text-red-500 border border-red-200 px-3 py-1 rounded">Closed</span>`;
                else if((att >= (e.attempts||1)) || (isClosed && sub)) btn=`<button onclick="reviewExam('${e.id}')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-xs font-bold">Review</button>`;
                else btn=`<button onclick="startExam('${e.id}')" class="bg-canvas-accent text-white px-3 py-1 rounded text-xs font-bold shadow">Take Quiz</button>`;
            }
            return `<div class="bg-white p-4 border rounded flex justify-between items-center hover:bg-gray-50 transition"><div class="flex gap-4 items-center"><div class="text-2xl text-gray-400"><i class="fas fa-rocket"></i></div><div><h4 class="font-bold hover:underline cursor-pointer text-canvas-primary">${e.title}</h4><div class="text-xs text-gray-500 flex gap-3 mt-1"><span>Due: ${formatDate(e.dueDate)}</span><span>${e.questions.length} Qs</span><span>Att: ${att}/${e.attempts||1}</span></div></div></div>${btn}</div>`;
        }).join('')}</div>`;
        c.innerHTML = html;
    }

    // --- GRADES TAB (RESTORED) ---
    if(currentTab === 'grades') {
        const enrolled = db.users.filter(u => s.students.includes(u.id));
        const weights = s.gradingWeights || { ww: 40, pt: 40, qa: 20 };
        const quizzes = db.exams[s.id] || [], activities = db.activities[s.id] || [];
        const wwItems = [...quizzes.filter(q=>q.category!=='qa'), ...activities.filter(a=>a.category!=='pt')];
        const ptItems = activities.filter(a=>a.category==='pt'), qaItems = quizzes.filter(q=>q.category==='qa');
        
        let html = `<div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-gray-800">Class Record</h2>${isTeacher?`<div class="flex gap-2"><button onclick="openWeightsModal()" class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-xs font-bold border">Weights</button><button onclick="resetGrades()" class="bg-red-50 text-red-600 border border-red-200 px-3 py-1 rounded text-xs font-bold">Reset All</button></div>`:''}</div>`;
        html += `<div class="overflow-x-auto bg-white border rounded shadow-sm"><table class="w-full text-left text-sm grade-table"><thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b"><tr><th class="p-4 sticky left-0 bg-gray-50 border-r">Student</th><th class="p-4 text-center">WW (${weights.ww}%)</th><th class="p-4 text-center">PT (${weights.pt}%)</th><th class="p-4 text-center">QA (${weights.qa}%)</th><th class="p-4 text-center bg-gray-100">Grade</th></tr></thead><tbody class="divide-y">`;
        
        enrolled.forEach(stu => {
            const calc = (items) => { let score=0, max=0; items.forEach(i => { 
                let s=0, m=0;
                if(i.questions) { m=i.questions.length; const sub=db.examSubmissions[i.id]?.[stu.id]; if(sub && sub.score!==undefined) { s=sub.score; m=100; } }
                else { m=parseInt(i.maxScore); const sub=db.activitySubmissions[i.id]?.[stu.id]; if(typeof sub==='number') s=sub; else if(sub && typeof sub==='object') s=sub.score||0; }
                score+=s; max+=m; 
            }); return max===0 ? 0 : (score/max)*100; };
            const ww=calc(wwItems), pt=calc(ptItems), qa=calc(qaItems), final = (ww*(weights.ww/100))+(pt*(weights.pt/100))+(qa*(weights.qa/100));
            html += `<tr class="hover:bg-gray-50"><td class="p-4 font-bold text-gray-700 sticky left-0 bg-white border-r flex items-center gap-2">${renderAvatar(stu, 'w-6 h-6', 'text-[10px]')}${stu.name}</td><td class="p-4 text-center">${Math.round(ww)}%</td><td class="p-4 text-center">${Math.round(pt)}%</td><td class="p-4 text-center">${Math.round(qa)}%</td><td class="p-4 text-center font-bold bg-gray-50">${Math.round(final)}</td></tr>`;
        });
        html += `</tbody></table></div>`;
        c.innerHTML = html;
    }
    
    if(currentTab === 'people') {
        const ppl = db.users.filter(u=>s.students.includes(u.id));
        c.innerHTML = `<h2 class="text-xl font-bold mb-4">People</h2><div class="bg-white border rounded divide-y">${ppl.map(u=>`<div class="p-3 flex items-center gap-3">${renderAvatar(u)} ${u.name}</div>`).join('')}</div>`;
    }
}

// --- MODULE BUILDER LOGIC ---
window.openModuleBuilder = () => { builderBlocks = []; editingModuleId = null; currentView = 'module_builder'; render(); }
window.editModule = (mid) => { const m = db.modules[currentCourseId].find(x=>x.id===mid); builderBlocks = JSON.parse(JSON.stringify(m.blocks)); editingModuleId = mid; $('mod-title-input') ? $('mod-title-input').value=m.title : null; currentView = 'module_builder'; render(); }
window.deleteModule = (mid) => { showConfirm("Delete Module?", () => { db.modules[currentCourseId] = db.modules[currentCourseId].filter(m=>m.id!==mid); saveDB(); render(); }); }

function renderModuleBuilder(c) {
    const title = editingModuleId ? db.modules[currentCourseId].find(m=>m.id===editingModuleId).title : "";
    c.innerHTML = `
        <div class="max-w-4xl mx-auto pb-24">
            <div class="flex justify-between items-center mb-6 bg-white p-4 rounded shadow-sm border">
                <input id="mod-title-input" value="${title}" class="text-xl font-bold bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none w-full mr-4" placeholder="Module Title (e.g. Week 1: Mechanics)">
                <div class="flex gap-2">
                    <button onclick="cancelModule()" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded">Cancel</button>
                    <button onclick="saveModule()" class="px-4 py-2 bg-green-600 text-white font-bold rounded shadow">Save</button>
                </div>
            </div>
            <div id="blocks-list" class="space-y-4"></div>
            <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 flex justify-center gap-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
                <button onclick="addBlock('text')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-blue-50 text-gray-700 font-bold border"><i class="fas fa-font text-blue-500"></i> Text</button>
                <button onclick="addBlock('image')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-blue-50 text-gray-700 font-bold border"><i class="fas fa-image text-green-500"></i> Image</button>
                <button onclick="addBlock('video')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-blue-50 text-gray-700 font-bold border"><i class="fas fa-video text-red-500"></i> Video</button>
                <button onclick="addBlock('file')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-blue-50 text-gray-700 font-bold border"><i class="fas fa-paperclip text-gray-500"></i> File</button>
            </div>
        </div>
    `;
    renderBlocks();
}

window.renderBlocks = () => {
    const el = $('blocks-list'); if(!el) return;
    el.innerHTML = builderBlocks.map((b, i) => `
        <div class="module-block group">
            <div class="block-actions">
                <button onclick="moveBlock(${i}, -1)" class="p-1 hover:text-blue-600" title="Move Up"><i class="fas fa-arrow-up"></i></button>
                <button onclick="moveBlock(${i}, 1)" class="p-1 hover:text-blue-600" title="Move Down"><i class="fas fa-arrow-down"></i></button>
                <button onclick="removeBlock(${i})" class="p-1 hover:text-red-500" title="Delete"><i class="fas fa-times"></i></button>
            </div>
            ${renderBlockContent(b, i)}
        </div>
    `).join('');
}

function renderBlockContent(b, i) {
    if(b.type === 'text') {
        return `
            <div class="rich-toolbar">
                <button class="rich-btn" onclick="execCmd(${i}, 'bold')"><i class="fas fa-bold"></i></button>
                <button class="rich-btn" onclick="execCmd(${i}, 'italic')"><i class="fas fa-italic"></i></button>
                <button class="rich-btn" onclick="execCmd(${i}, 'underline')"><i class="fas fa-underline"></i></button>
                <select onchange="execCmd(${i}, 'fontSize', this.value)" class="rich-btn h-6 py-0"><option value="3">Normal</option><option value="5">Large</option><option value="7">Huge</option></select>
                <input type="color" onchange="execCmd(${i}, 'foreColor', this.value)" class="w-6 h-6 border-0 p-0 cursor-pointer">
            </div>
            <div id="editor-${i}" class="rich-content w-full bg-gray-50" contenteditable="true" oninput="updateBlock(${i}, this.innerHTML)">${b.content}</div>
        `;
    } else if (b.type === 'video') {
        return `<label class="block text-xs font-bold text-gray-500 mb-2">YouTube URL</label><input class="w-full border p-2 rounded" value="${b.content}" onchange="updateBlock(${i}, this.value)" placeholder="https://www.youtube.com/watch?v=...">`;
    } else {
        return `<div class="flex items-center gap-4"><input type="file" onchange="uploadBlockFile(${i}, this)">${b.content ? `<span class="text-green-600 text-xs font-bold"><i class="fas fa-check"></i> Uploaded</span>` : ''}</div>`;
    }
}

window.addBlock = (type) => { builderBlocks.push({ type, content: '' }); renderBlocks(); }
window.removeBlock = (i) => { builderBlocks.splice(i, 1); renderBlocks(); }
window.moveBlock = (i, dir) => { if(i+dir>=0 && i+dir<builderBlocks.length) { [builderBlocks[i], builderBlocks[i+dir]] = [builderBlocks[i+dir], builderBlocks[i]]; renderBlocks(); } }
window.updateBlock = (i, val) => { builderBlocks[i].content = val; }
window.execCmd = (i, cmd, val=null) => { document.execCommand(cmd, false, val); builderBlocks[i].content = document.getElementById(`editor-${i}`).innerHTML; }
window.uploadBlockFile = (i, input) => { if(input.files[0]) { const r = new FileReader(); r.onload = e => { builderBlocks[i].content = e.target.result; builderBlocks[i].name = input.files[0].name; renderBlocks(); }; r.readAsDataURL(input.files[0]); } }
window.cancelModule = () => { goCourse(); }
window.saveModule = () => {
    const title = $('mod-title-input').value;
    if(!title) return showToast('Title required', 'error');
    if(!db.modules[currentCourseId]) db.modules[currentCourseId] = [];
    const mod = { id: editingModuleId || 'm'+Date.now(), title, blocks: builderBlocks, date: new Date().toISOString() };
    if(editingModuleId) { const idx = db.modules[currentCourseId].findIndex(m=>m.id===editingModuleId); db.modules[currentCourseId][idx] = mod; } 
    else { db.modules[currentCourseId].push(mod); }
    saveDB(); goCourse(); showToast('Module Saved');
}
function goCourse() { currentView = 'course'; render(); }

window.viewModule = (mid) => {
    const m = db.modules[currentCourseId].find(x=>x.id===mid);
    const content = m.blocks.map(b => {
        if(b.type === 'text') return `<div class="mb-4 text-gray-800">${b.content}</div>`;
        if(b.type === 'image') return `<img src="${b.content}" class="w-full h-auto rounded mb-4 shadow">`;
        if(b.type === 'video') return `<div class="embed-container mb-4"><iframe src="${b.content.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe></div>`;
        if(b.type === 'file') return `<a href="${b.content}" download="${b.name||'file'}" class="block bg-blue-50 border border-blue-200 p-3 rounded mb-4 text-blue-700 hover:bg-blue-100 font-bold"><i class="fas fa-paperclip mr-2"></i> Download ${b.name||'File'}</a>`;
    }).join('');
    renderModal('mod-view', m.title, `<div class="p-2">${content}</div>`);
}

window.publishPost = () => { const c=$('post-content').value, t=$('post-type').value; let u=$('post-url').value; if(t==='image_upload') u=tempTeacherImage; if(c||u) { if(!db.posts) db.posts=[]; db.posts.push({id:'p'+Date.now(), courseId:currentCourseId, authorId:currentUser.id, authorName:currentUser.name, date:new Date().toISOString(), content:c, mediaType:t, mediaUrl:u, isPinned:false}); tempTeacherImage=null; saveDB(); render(); } }
window.toggleMediaInput = () => { const t=$('post-type').value; $('post-url').classList.toggle('hidden', t!=='link'&&t!=='video'&&t!=='image_url'&&t!=='gif'); $('post-file-container').classList.toggle('hidden', t!=='image_upload'); }
window.editIntro = () => { const s=db.subjects.find(x=>x.id===currentCourseId); const t=prompt('Title:',s.introTitle); if(t!==null){ const b=prompt('Body:',s.introBody); if(b!==null){ s.introTitle=t; s.introBody=b; saveDB(); render(); }}}
window.enrollStudents = () => { const ids=Array.from(document.querySelectorAll('.student-select:checked')).map(cb=>cb.value); const s=db.subjects.find(x=>x.id===currentCourseId); if(ids.length>0){ s.students.push(...ids); saveDB(); toggleModal('modal-add-student'); render(); } }
window.downloadTemplate = () => { const t=`1. Question?\nA. Opt A\nB. Opt B\nAnswer: A`; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([t],{type:'text/plain'})); a.download='Template.txt'; a.click(); }
document.addEventListener('change', async (e) => { if(e.target && e.target.id === 'docx-upload') { const reader = new FileReader(); reader.onload = function(evt) { mammoth.extractRawText({arrayBuffer: evt.target.result}).then(r => { importedText = r.value; showToast('File Parsed'); }); }; reader.readAsArrayBuffer(e.target.files[0]); } });
window.processDocxImport = () => { const o=$('imp-open').value, d=$('imp-due').value; if(importedText && o && d) { const q=parseQuizText(importedText); if(q.length>0) { if(!db.exams[currentCourseId]) db.exams[currentCourseId]=[]; db.exams[currentCourseId].push({id:'e'+Date.now(), title:'Imported Quiz', openDate:o, dueDate:d, timeLimit:30, attempts:1, category:'ww', questions:q}); saveDB(); closeModal('modal-import'); render(); showToast('Imported'); } } }
window.deletePost = (pid) => { showConfirm('Delete post?', () => { db.posts = db.posts.filter(p => p.id !== pid); saveDB(); render(); }); }
window.togglePinPost = (pid) => { const p = db.posts.find(post => post.id === pid); if(p) { p.isPinned = !p.isPinned; saveDB(); render(); showToast(p.isPinned ? 'Post Pinned' : 'Post Unpinned'); } }
window.removeStudentFromCourse = (sid, uid) => { showConfirm('Remove student?', () => { const s = db.subjects.find(x => x.id === sid); if(s) { s.students = s.students.filter(id => id !== uid); saveDB(); render(); } }); }

// --- ACTIVITY LOGIC (ENHANCED) ---
window.openActivityModal = () => { renderModal('act-modal', 'Create Activity', `<div class="space-y-3"><input id="act-title" class="w-full border p-2 rounded" placeholder="Title"><textarea id="act-desc" class="w-full border p-2 rounded h-20" placeholder="Instructions..."></textarea><div class="grid grid-cols-2 gap-2"><select id="act-cat" class="border p-2 rounded bg-white"><option value="ww">Written Work</option><option value="pt">Perf Task</option></select><input id="act-max" type="number" class="border p-2 rounded" value="100"></div><div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold text-gray-500">Unlock</label><input id="act-open" type="datetime-local" class="w-full border p-2 rounded"></div><div><label class="text-xs font-bold text-gray-500">Due (Lock)</label><input id="act-due" type="datetime-local" class="w-full border p-2 rounded"></div></div><div><label class="text-xs font-bold text-gray-500">File</label><input type="file" id="act-file" class="w-full text-sm"></div><button onclick="saveAct()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Save</button></div>`); }
window.saveAct = () => { const title=$('act-title').value, desc=$('act-desc').value, cat=$('act-cat').value, max=$('act-max').value, open=$('act-open').value, due=$('act-due').value, file=$('act-file'); const save = (f) => { if(!db.activities[currentCourseId]) db.activities[currentCourseId] = []; db.activities[currentCourseId].push({id:'a'+Date.now(), title, description:desc, category:cat, maxScore:max, openDate:open, dueDate:due, instructionFile:f}); saveDB(); closeModal('act-modal'); render(); }; if(file.files[0]) { const r=new FileReader(); r.onload=e=>save({name:file.files[0].name, data:e.target.result}); r.readAsDataURL(file.files[0]); } else save(null); }
window.openActivityDetail = (aid) => { const act = db.activities[currentCourseId].find(a => a.id === aid); if(currentUser.role !== 'student') { const s = db.subjects.find(x => x.id === currentCourseId); const students = db.users.filter(u => s.students.includes(u.id)); renderModal('act-grade', act.title, `<div class="space-y-2 max-h-[60vh] overflow-y-auto">${students.map(u => { const sub = db.activitySubmissions[aid]?.[u.id] || {}; let score = ''; if (typeof sub === 'number' || typeof sub === 'string') score = sub; else if (sub && typeof sub === 'object') score = sub.score !== undefined ? sub.score : ''; return `<div onclick="gradeStudent('${aid}','${u.id}')" class="p-2 border rounded hover:bg-gray-50 cursor-pointer flex justify-between"><span>${u.name}</span><span class="${sub.submittedAt?'text-green-600':'text-red-400'} text-xs font-bold">${score||'-'}/${act.maxScore}</span></div>`; }).join('')}</div>`); return; } const sub = db.activitySubmissions[aid]?.[currentUser.id] || {}; const now = new Date(); const isLocked = (act.openDate && now < new Date(act.openDate)) || (act.dueDate && now > new Date(act.dueDate) && !sub.submittedAt); if(isLocked) return showToast('Activity is Locked', 'error'); renderModal('act-sub', act.title, `<div class="space-y-4"><div class="bg-gray-50 p-3 rounded text-sm">${act.description}</div>${act.instructionFile ? `<a href="${act.instructionFile.data}" download="${act.instructionFile.name}" class="text-blue-600 underline text-sm">Download Attached File</a>` : ''}<div class="border rounded p-2"><div class="flex gap-2 mb-2 border-b pb-2"><button onclick="document.execCommand('bold',false,null)" class="font-bold border px-2 rounded">B</button><button onclick="document.execCommand('italic',false,null)" class="italic border px-2 rounded">I</button><button onclick="document.execCommand('underline',false,null)" class="underline border px-2 rounded">U</button></div><div id="sub-editor" contenteditable="true" class="h-32 outline-none overflow-y-auto">${sub.textAnswer || ''}</div></div><input type="file" id="sub-file" class="text-sm">${sub.fileUrl ? `<div class="text-xs text-green-600">File uploaded previously</div>` : ''}<button onclick="submitWork('${aid}')" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Submit</button>${sub.score ? `<div class="text-center font-bold text-xl text-green-600 mt-2">Grade: ${sub.score}/${act.maxScore}</div>` : ''}</div>`); }
window.submitWork = (aid) => { const text = $('sub-editor').innerHTML; const file = $('sub-file').files[0]; const save = (f) => { if(!db.activitySubmissions[aid]) db.activitySubmissions[aid] = {}; db.activitySubmissions[aid][currentUser.id] = { textAnswer:text, fileUrl:f?f.data:null, fileName:f?f.name:null, submittedAt:new Date().toISOString() }; saveDB(); closeModal('act-sub'); showToast('Submitted!'); }; if(file) { const r=new FileReader(); r.onload=e=>save({name:file.name, data:e.target.result}); r.readAsDataURL(file); } else save(null); }
window.gradeStudent = (aid, uid) => { const sub = db.activitySubmissions[aid]?.[uid] || {}; renderModal('grade-one', 'Grade Submission', `<div class="space-y-3"><div class="bg-gray-100 p-3 rounded min-h-[50px]">${sub.textAnswer || 'No text answer.'}</div>${sub.fileUrl ? `<a href="${sub.fileUrl}" download="${sub.fileName}" class="text-blue-600 underline block">Download Student File</a>` : ''}<div class="flex gap-2 items-center"><label>Score:</label><input id="g-score" type="number" value="${sub.score!==undefined?sub.score:''}" class="border p-1 w-20"></div><input id="g-comment" class="w-full border p-2 rounded" placeholder="Feedback..." value="${sub.teacherComment||''}"><button onclick="saveStudentGrade('${aid}','${uid}')" class="w-full bg-green-600 text-white py-2 rounded">Save Grade</button></div>`); }
window.saveStudentGrade = (aid, uid) => { const s=$('g-score').value, c=$('g-comment').value; if(!db.activitySubmissions[aid]) db.activitySubmissions[aid]={}; const prev = db.activitySubmissions[aid][uid] || {}; db.activitySubmissions[aid][uid] = { ...prev, score:s===''?undefined:parseInt(s), teacherComment:c }; saveDB(); closeModal('grade-one'); closeModal('act-grade'); }
window.deleteActivity = (aid) => { showConfirm('Delete?', () => { db.activities[currentCourseId] = db.activities[currentCourseId].filter(a => a.id !== aid); delete db.activitySubmissions[aid]; saveDB(); render(); }); }

// --- EXAM LOGIC (RESTORED) ---
window.openCreateModal = (examId=null) => { 
    let exam = { title: '', openDate: '', dueDate: '', timeLimit: 30, attempts: 1, category: 'ww' };
    let content = '', titleText = 'Create Quiz', btnText = 'Publish';
    if (examId) { exam = db.exams[currentCourseId].find(e => e.id === examId); if (exam) { content = questionsToText(exam.questions); titleText = 'Edit Quiz'; btnText = 'Save'; } }
    renderModal('quiz', titleText, `<div class="space-y-3"><input id="q-title" class="w-full border p-2 rounded" placeholder="Title" value="${exam.title}"><div class="grid grid-cols-2 gap-2"><div><label class="text-xs">Start</label><input id="q-open" type="datetime-local" class="w-full border p-2 rounded" value="${exam.openDate}"></div><div><label class="text-xs">Due</label><input id="q-due" type="datetime-local" class="w-full border p-2 rounded" value="${exam.dueDate}"></div></div><div class="grid grid-cols-2 gap-2"><div><label class="text-xs">Time (min)</label><input id="q-timelimit" type="number" class="w-full border p-2 rounded" value="${exam.timeLimit}"></div><div><label class="text-xs">Attempts</label><input id="q-attempts" type="number" class="w-full border p-2 rounded" value="${exam.attempts}"></div></div><textarea id="q-content" class="w-full border p-2 rounded h-40 text-sm font-mono" placeholder="1. Question?\nA. Yes\nB. No\nAnswer: A">${content}</textarea><button onclick="saveQuiz('${examId||''}')" class="w-full bg-blue-600 text-white py-2 rounded font-bold">${btnText}</button></div>`); 
}
window.saveQuiz = (eid) => { const t=$('q-title').value, o=$('q-open').value, d=$('q-due').value, tm=$('q-timelimit').value, at=$('q-attempts').value, ct=$('q-content').value; if(t&&o&&d){ let qs = ct ? parseQuizText(ct) : []; if(qs.length===0) qs=[{q:'Sample?', options:['Yes','No'], ans:0}]; if(!db.exams[currentCourseId]) db.exams[currentCourseId]=[]; const dat = {id:eid||'e'+Date.now(), title:t, openDate:o, dueDate:d, timeLimit:parseInt(tm), attempts:parseInt(at), category:'ww', questions:qs}; if(eid){ const i=db.exams[currentCourseId].findIndex(e=>e.id===eid); db.exams[currentCourseId][i]=dat; } else { db.exams[currentCourseId].push(dat); } saveDB(); closeModal('quiz'); render(); } else showToast('Missing fields', 'error'); }
window.deleteExam = (eid) => { showConfirm('Delete quiz?', ()=>{ db.exams[currentCourseId]=db.exams[currentCourseId].filter(e=>e.id!==eid); delete db.examSubmissions[eid]; saveDB(); render(); }); }
window.startExam = (eid) => { activeExamId=eid; currentView='exam-take'; render(); }
window.reviewExam = (eid) => { activeExamId=eid; currentView='exam-review'; render(); }
window.submitExam = () => { const ex=db.exams[currentCourseId].find(e=>e.id===activeExamId), ans=[]; let score=0; ex.questions.forEach((q,i) => { const s=document.querySelector(`input[name="q${i}"]:checked`); const v=s?parseInt(s.value):-1; ans.push(v); if(v===q.ans)score++; }); const p=Math.round((score/ex.questions.length)*100); if(!db.examSubmissions[activeExamId]) db.examSubmissions[activeExamId]={}; const prev = db.examSubmissions[activeExamId][currentUser.id]; const attemptCount = prev ? (prev.attemptsTaken || 0) + 1 : 1; db.examSubmissions[activeExamId][currentUser.id] = { score: p, answers: ans, attemptsTaken: attemptCount }; saveDB(); showToast(`Submitted! Score: ${p}%`); if(attemptCount >= (ex.attempts || 1)) { reviewExam(activeExamId); } else { currentView='course'; currentTab='quizzes'; render(); } }
window.renderExamTake = (c) => { const s = db.subjects.find(x => x.id === currentCourseId); const ex = db.exams[s.id].find(e => e.id === activeExamId); let mins=parseInt(ex.timeLimit||30), secs=0; let lastPassage = ''; c.innerHTML = `<div class="max-w-4xl mx-auto bg-white min-h-screen border-x border-gray-200"><div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10 shadow-sm"><h1 class="text-2xl font-bold text-gray-800">${ex.title}</h1><div class="text-xl font-mono font-bold text-red-600" id="timer">--:--</div></div><div class="p-8 space-y-8">${ex.questions.map((q,i) => { let passageHtml = ''; if (q.passage && q.passage !== lastPassage) { lastPassage = q.passage; passageHtml = `<div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-gray-800 mb-6 font-serif leading-relaxed whitespace-pre-line">${q.passage}</div>`; } else if (!q.passage) { lastPassage = ''; } return `${passageHtml}<div class="bg-gray-50 p-6 rounded border border-gray-200"><p class="text-lg font-medium mb-4"><span class="font-bold text-gray-400 mr-2">${i+1}.</span>${q.q}</p><div class="space-y-2">${q.options.map((o,oi)=>`<label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-blue-50 transition"><input type="radio" name="q${i}" value="${oi}" class="mr-3 w-4 h-4 text-canvas-accent"><span>${o}</span></label>`).join('')}</div></div>`; }).join('')}</div><div class="p-6 border-t bg-gray-50 flex justify-end gap-4 sticky bottom-0 shadow-inner"><button onclick="render()" class="text-gray-500 font-bold hover:text-gray-700">Cancel</button><button onclick="submitExam()" class="bg-canvas-accent text-white px-8 py-2 rounded font-bold shadow hover:bg-blue-700 transition">Submit Quiz</button></div></div>`; const int = setInterval(() => { if(!$('timer')) { clearInterval(int); return; } if(secs===0) { if(mins===0) { clearInterval(int); submitExam(); return; } mins--; secs=59; } else secs--; $('timer').innerText=`${mins}:${secs<10?'0':''}${secs}`; }, 1000); }
window.renderExamReview = (c) => { const s = db.subjects.find(x => x.id === currentCourseId); const ex = db.exams[s.id].find(e => e.id === activeExamId); const sub = db.examSubmissions[activeExamId][currentUser.id]; let lastPassage = ''; c.innerHTML = `<div class="max-w-4xl mx-auto bg-white min-h-screen border-x border-gray-200"><div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10 shadow-sm bg-green-50"><div><h1 class="text-2xl font-bold text-gray-800">${ex.title} (Review)</h1><p class="text-sm text-gray-600">Final Score: <span class="font-bold text-lg">${sub.score}%</span></p></div><button onclick="render()" class="text-gray-500 font-bold hover:text-gray-700">Close Review</button></div><div class="p-8 space-y-8">${ex.questions.map((q,i) => { let passageHtml = ''; if (q.passage && q.passage !== lastPassage) { lastPassage = q.passage; passageHtml = `<div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-gray-800 mb-6 font-serif leading-relaxed whitespace-pre-line">${q.passage}</div>`; } else if (!q.passage) { lastPassage = ''; } const userAns = (sub.answers && sub.answers[i] !== undefined) ? sub.answers[i] : -1; const isSkipped = userAns === -1; const isCorrect = userAns === q.ans; let statusHtml = isSkipped ? '<span class="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-1 rounded ml-2">Not Answered</span>' : (isCorrect ? '<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded ml-2">Correct</span>' : '<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded ml-2">Incorrect</span>'); let borderClass = isSkipped ? 'border-amber-300 bg-amber-50/20' : (isCorrect ? 'border-green-300 bg-green-50/20' : 'border-red-300 bg-red-50/20'); return `${passageHtml}<div class="bg-white p-6 rounded border ${borderClass}"><p class="text-lg font-medium mb-4"><span class="font-bold text-gray-400 mr-2">${i+1}.</span>${q.q} ${statusHtml}</p><div class="space-y-2">${q.options.map((o,oi)=> { let cls = "border-gray-200"; let icon = ""; if (oi === q.ans) { cls = "border-green-500 bg-green-100 font-bold"; icon = '<div class="ml-auto flex items-center text-green-700 text-xs font-bold"><i class="fas fa-check mr-1"></i> Correct Answer</div>'; } else if (oi === userAns && !isCorrect) { cls = "border-red-500 bg-red-100"; icon = '<div class="ml-auto flex items-center text-red-700 text-xs font-bold"><i class="fas fa-times mr-1"></i> Your Answer</div>'; } return `<div class="flex items-center p-3 border rounded ${cls}"><span class="mr-3 font-mono">${String.fromCharCode(65+oi)}.</span><span class="flex-1">${o}</span>${icon}</div>` }).join('')}</div></div>`; }).join('')}</div></div>`; }
function questionsToText(questions) { let textOutput = "", lastPassage = ""; questions.forEach((q, i) => { if (q.passage && q.passage !== lastPassage) { textOutput += `\n${q.passage}\n\n`; lastPassage = q.passage; } textOutput += `${i+1}. ${q.q}\n`; q.options.forEach((opt, idx) => { textOutput += `${String.fromCharCode(65+idx)}. ${opt}\n`; }); textOutput += `Answer: ${String.fromCharCode(65+q.ans)}\n\n`; }); return textOutput.trim(); }

window.toggleModal = (id) => { if($(id)){ $(id).remove(); return; } }
window.closeModal = (id) => { const el = document.getElementById(id); if (el) el.remove(); } 
window.renderModal = (id,t,h) => { if($(id)) $(id).remove(); $('modal-portal').innerHTML=`<div id="${id}" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm"><div class="bg-white p-6 rounded w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg">${t}</h3><button onclick="closeModal('${id}')"><i class="fas fa-times"></i></button></div>${h}</div></div>`; }

// Re-render
render();
</script>
</body>
</html>


