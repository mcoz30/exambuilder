<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LearnNovaLMS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2D3B45">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Lato"', 'sans-serif'] },
                    colors: {
                        canvas: { 
                            base: '#2D3B45', 
                            primary: '#0e1e24', 
                            accent: '#0374B5', 
                            danger: '#EE4D3D', 
                            success: '#00AC18',
                            light: '#F5F5F5'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F5F5F5; color: #2D3B45; }
        
        /* Global Nav */
        #global-nav { width: 84px; flex-shrink: 0; background-color: #2D3B45; display: flex; flex-direction: column; align-items: center; padding-top: 1rem; z-index: 50; }
        .nav-item { color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 0.75rem 0; cursor: pointer; transition: background 0.2s; position: relative; }
        .nav-item:hover { background-color: #fff; color: #2D3B45; }
        .nav-item.active { background-color: #fff; color: #0374B5; border-left: 4px solid #0374B5; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .nav-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }

        /* Course Cards */
        .course-card { transition: transform 0.2s, box-shadow 0.2s; }
        .course-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .course-header { height: 140px; background-size: cover; background-position: center; position: relative; }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #E2E8F0; border: 1px solid #E2E8F0; }
        .cal-cell { background: white; min-height: 120px; padding: 0.5rem; position: relative; }
        .cal-cell.today { background: #F0F9FF; }
        .event-pill { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; items-center; gap: 4px; transition: opacity 0.2s; }
        
        /* Feed */
        .embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; margin-top: 10px; } 
        .embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        @media (max-width: 768px) {
            #main-layout { flex-direction: column; }
            #global-nav { width: 100%; height: 60px; flex-direction: row; padding: 0; justify-content: space-around; position: fixed; bottom: 0; }
            .nav-item { padding: 0.5rem; }
            .nav-label { display: none; }
            #content-area { padding-bottom: 80px; }
            .calendar-grid { display: flex; flex-direction: column; gap: 8px; border: none; background: transparent; }
            .cal-cell { min-height: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
            .cal-header-row { display: none; }
        }
        
        #loading-screen { position: fixed; inset: 0; background: #2D3B45; z-index: 9999; display: flex; justify-content: center; items-center; color: white; flex-direction: column; gap: 1rem; transition: opacity 0.5s; }
        #sync-status { position: fixed; bottom: 1rem; right: 1rem; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; z-index: 100; display: flex; items-center; gap: 0.5rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        
        /* Tables */
        .grade-table th { white-space: nowrap; }
    </style>
</head>
<body class="h-screen overflow-hidden text-sm">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <i class="fas fa-circle-notch fa-spin text-4xl"></i>
        <p class="font-bold tracking-widest">CONNECTING TO DATABASE...</p>
    </div>

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    <div id="sync-status"><i class="fas fa-save"></i> Saved to Firebase</div>

    <!-- Main App -->
    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500"></div>
    <!-- Modal Portal -->
    <div id="modal-portal" class="relative z-[60]"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- FIREBASE CONFIGURATION ---
let firebaseConfig;
const userConfig = {
    apiKey: "AIzaSyAZhN6M2AOAi_9NGgHw-lU-vZDDBGyIEAY",
    authDomain: "schoollms-475c9.firebaseapp.com",
    projectId: "schoollms-475c9",
    storageBucket: "schoollms-475c9.firebasestorage.app",
    messagingSenderId: "123401573481",
    appId: "1:123401573481:web:ca5179b069919236797ef8"
};

let appId = 'schoollms-v1'; 

if (typeof __firebase_config !== 'undefined') {
    firebaseConfig = JSON.parse(__firebase_config);
    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
} else {
    firebaseConfig = userConfig;
}

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const dbStore = getFirestore(app);

// Data Path: Single Master Record for easy syncing
const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data/school_system`;
const MASTER_DOC_ID = 'master_record';

/**
 * ------------------------------------------------------------------
 * DATA STORE & STATE
 * ------------------------------------------------------------------
 */
const defaultData = {
    users: [
        { id: 'u1', name: 'Mrs. Anderson', role: 'teacher', username: 'teacher', password: '123', avatar: 'MA' },
        { id: 'u2', name: 'Juan Dela Cruz', role: 'student', username: 'student', password: '123', avatar: 'JD' },
        { id: 'u3', name: 'Maria Santos', role: 'student', username: 'student2', password: '123', avatar: 'MS' },
        { id: 'u0', name: 'School Admin', role: 'admin', username: 'admin', password: '0916Saidee', avatar: 'AD' } 
    ],
    subjects: [
        { 
            id: 's1', 
            name: 'Introduction to Physics', 
            code: 'PHYS-101', 
            teacherId: 'u1', 
            students: ['u2', 'u3'], 
            color: '#0374B5', 
            img: 'https://images.unsplash.com/photo-1636466497217-26a8cbeaf0aa?auto=format&fit=crop&w=600&q=80',
            introTitle: 'Welcome to Physics',
            introBody: 'Check the feed for daily updates.',
            gradingWeights: { ww: 40, pt: 40, qa: 20 }
        }
    ],
    posts: [
        { 
            id: 'p1', courseId: 's1', authorId: 'u1', authorName: 'Mrs. Anderson', date: '2023-10-24T09:00',
            content: 'Please review this video on Newton\'s Laws.',
            mediaType: 'video', mediaUrl: 'https://www.youtube.com/embed/kKKM8Y-u7ds',
            isPinned: false
        }
    ],
    globalPosts: [],
    // Manual Activities (Performance Tasks, Manual Written Work)
    activities: {
        's1': [
            { id: 'a1', title: 'Lab Report #1', maxScore: 50, category: 'pt', date: '2023-10-28' }
        ]
    },
    // Grades for Manual Activities
    activitySubmissions: {
        'a1': { 'u2': 45, 'u3': 48 }
    },
    exams: {
        's1': [
            { 
                id: 'e1', title: 'Forces Quiz', openDate: '2023-10-25T08:00', dueDate: '2025-12-31T23:59', 
                timeLimit: 30, attempts: 1, category: 'ww', // ww = Written Work, qa = Quarterly Assessment
                questions: [{q:'F=ma?', options:['Yes','No'], ans:0}] 
            }
        ]
    },
    examSubmissions: {
        'e1': { 'u2': { score: 100, answers: [0], attemptsTaken: 1 } } // Score is Percentage here for exams
    }
};

// Global State
let db = defaultData; 
let currentUser = null;
let currentView = 'login'; 
let currentCourseId = null;
let activeExamId = null;
let currentTab = 'home';
let calendarDate = new Date();
let importedText = ''; 
let tempPostImage = null; 
let tempTeacherImage = null;
let adminCourseFilter = 'all';
let selectedLoginRole = null; 
let firebaseUser = null; 

// --- FIREBASE SYNC LOGIC ---

async function initFirebase() {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                firebaseUser = user;
                const docRef = doc(dbStore, PUBLIC_DATA_PATH, MASTER_DOC_ID);
                
                // Real-time listener
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        db = docSnap.data();
                        // Migration Check: Ensure new fields exist
                        if(!db.activities) db.activities = {};
                        if(!db.activitySubmissions) db.activitySubmissions = {};
                        // Ensure subjects have weights
                        db.subjects.forEach(s => {
                             if(!s.gradingWeights) s.gradingWeights = { ww: 40, pt: 40, qa: 20 };
                        });

                        if (currentUser) render(); 
                    } else {
                        setDoc(docRef, defaultData);
                        db = defaultData;
                    }
                    const loader = document.getElementById('loading-screen');
                    if(loader) {
                        loader.style.opacity = 0;
                        setTimeout(() => loader.remove(), 500);
                        document.getElementById('app').classList.remove('opacity-0');
                    }
                    if(!currentUser) render(); 
                }, (error) => {
                     console.error("Firestore Read Error:", error);
                     showToast("Database Access Denied: " + error.message, "error");
                });
            }
        });
    } catch (e) {
        console.error("Firebase Init Error:", e);
        showToast("Firebase Connection Failed: " + e.message, "error");
    }
}

async function saveDB() {
    if (!firebaseUser) return;
    const status = document.getElementById('sync-status');
    if(status) status.style.opacity = 1;
    
    try {
        const docRef = doc(dbStore, PUBLIC_DATA_PATH, MASTER_DOC_ID);
        await setDoc(docRef, db);
        if(status) setTimeout(() => status.style.opacity = 0, 1000);
    } catch (e) {
        console.error("Save Error:", e);
        showToast("Error saving data: " + e.message, "error");
    }
}

initFirebase();

// --- APP HELPERS ---
const $ = (id) => document.getElementById(id);
window.$ = $; // Expose to window for inline onclick handlers

const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
const showToast = (msg, type='info') => {
    const box = document.createElement('div');
    box.className = `px-4 py-3 rounded shadow-lg text-white font-bold transform transition-all duration-300 translate-y-4 pointer-events-auto ${type==='error'?'bg-canvas-danger':'bg-canvas-accent'}`;
    box.innerText = msg;
    $('toast-container').appendChild(box);
    setTimeout(()=>box.remove(), 3000);
};

const showConfirm = (message, onYes) => {
    const id = 'confirm-modal';
    const html = `
        <div class="space-y-4">
            <p class="text-gray-700 font-bold">${message}</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('${id}')" class="px-4 py-2 rounded border hover:bg-gray-100 font-bold text-gray-500">Cancel</button>
                <button id="confirm-yes-btn" class="px-4 py-2 rounded bg-canvas-danger text-white font-bold hover:bg-red-600">Confirm</button>
            </div>
        </div>
    `;
    renderModal(id, 'Confirmation', html);
    setTimeout(() => {
        const btn = document.getElementById('confirm-yes-btn');
        if(btn) btn.onclick = () => { onYes(); closeModal(id); };
    }, 50);
};

// --- AVATAR HELPER ---
const renderAvatar = (user, sizeClass='w-8 h-8', textSize='text-xs') => {
    // If user has a photo URL (base64 or http), render image
    if (user && user.avatar && (user.avatar.startsWith('data:') || user.avatar.startsWith('http'))) {
        return `<img src="${user.avatar}" class="${sizeClass} rounded-full object-cover border border-gray-200 bg-white">`;
    }
    // Fallback to initials
    const initial = user ? (user.avatar || (user.name ? user.name[0] : '?')) : '?';
    // If initial is long (like a base64 string that missed checks), default to '?'
    const displayInitial = initial.length > 3 ? '?' : initial;
    
    return `<div class="${sizeClass} rounded-full bg-blue-100 text-blue-600 flex items-center justify-center ${textSize} font-bold border border-blue-200">${displayInitial}</div>`;
};

// --- QUIZ PARSER (SHARED) ---
window.parseQuizText = (text) => {
    const questions = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    let currQ = null;
    let currPassage = '';
    let tempBuffer = '';

    if (lines.some(l => l.includes('|')) && !lines.some(l => l.match(/^\d+[\.\)]/))) {
         lines.forEach(l => { 
             const p = l.replace(/^\d+[\.)]\s*/, '').split('|'); 
             if(p.length>=3) questions.push({ q:p[0].trim(), options:p[1].split(',').map(x=>x.trim()), ans:parseInt(p[2].trim()) }); 
         });
    } else {
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const ansMatch = line.match(/^(?:Answer|Ans|Key)[\s:\-\.]*([A-Z])/i) || line.match(/^\*([A-Z])/i);
            if (ansMatch && currQ) {
                let code = ansMatch[1].toUpperCase().charCodeAt(0) - 65;
                if(code >= 0 && code < 26) currQ.ans = code;
                continue;
            }
            const optMatch = line.match(/^[\(\s]*([A-Z])[\.\)\s]\s*(.*)/i);
            if (optMatch && currQ) {
                currQ.options.push(optMatch[2].trim());
                continue;
            }
            const qMatch = line.match(/^(\d+)[\.\)\s]\s*(.*)/);
            if (qMatch) {
                if (currQ) { if(currQ.options.length > 0) questions.push(currQ); }
                if (tempBuffer) { currPassage = tempBuffer.trim(); tempBuffer = ''; }
                let qText = qMatch[2].trim();
                currQ = { q: qText, options: [], ans: 0, passage: currPassage };
                continue;
            }
            if (line.length < 2 && !line.match(/[a-z]/i)) continue;
            if (tempBuffer) tempBuffer += '\n';
            tempBuffer += line;
        }
        if (currQ && currQ.options.length > 0) questions.push(currQ);
    }
    return questions;
};

window.onManualInput = (val) => {
    const qs = parseQuizText(val);
    const label = document.getElementById('manual-detected-label');
    if(label) {
        if(qs.length > 0) {
            label.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> ${qs.length} Questions Detected</span>`;
        } else {
            label.innerHTML = `<span class="text-gray-400">Typing... (No complete questions yet)</span>`;
        }
    }
}

/**
 * ------------------------------------------------------------------
 * ROUTER & LAYOUT
 * ------------------------------------------------------------------
 */
function render() {
    const app = $('app');
    if (!app) return;
    app.innerHTML = '';
    
    if(currentView === 'login') {
        renderLogin(app);
    } else {
        app.innerHTML = `
            <div id="main-layout" class="flex w-full h-full bg-[#F5F5F5]">
                <nav id="global-nav">
                    <div class="mb-6 hidden md:block"><i class="fas fa-shapes text-3xl text-white"></i></div>
                    <div class="nav-item ${currentView==='dashboard'?'active':''}" onclick="goDashboard()">
                        <i class="fas fa-tachometer-alt nav-icon"></i><span class="nav-label">Dashboard</span>
                    </div>
                    
                    ${currentUser.role === 'admin' ? `
                    <div class="nav-item ${currentView==='teachers_list'?'active':''}" onclick="goTeachersList()">
                        <i class="fas fa-chalkboard-teacher nav-icon"></i><span class="nav-label">Teachers</span>
                    </div>
                    ` : ''}

                    <div class="nav-item ${currentView==='courses_list' || currentView==='course'?'active':''}" onclick="goCoursesList()"> 
                        <i class="fas fa-book nav-icon"></i><span class="nav-label">Courses</span>
                    </div>
                    <div class="nav-item ${currentView==='calendar'?'active':''}" onclick="goCalendar()">
                        <i class="fas fa-calendar-alt nav-icon"></i><span class="nav-label">Calendar</span>
                    </div>
                    <div class="nav-item ${currentView==='settings'?'active':''}" onclick="goSettings()">
                        <i class="fas fa-cog nav-icon"></i><span class="nav-label">Settings</span>
                    </div>
                    <div class="mt-auto mb-4 nav-item" onclick="logout()">
                        <i class="fas fa-sign-out-alt nav-icon text-gray-400"></i><span class="nav-label text-gray-400">Logout</span>
                    </div>
                </nav>
                <main id="content-area" class="flex-1 overflow-y-auto relative">
                    <header class="bg-white border-b border-gray-300 h-16 flex items-center justify-between px-6 sticky top-0 z-40">
                        <div class="flex items-center gap-2 text-canvas-base">
                            <h2 class="font-bold text-lg uppercase tracking-wide" id="page-title">Dashboard</h2>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-gray-600">${currentUser.name}</span>
                            ${renderAvatar(currentUser, 'w-8 h-8', 'text-xs')}
                        </div>
                    </header>
                    <div id="page-content" class="p-6 md:p-8 max-w-7xl mx-auto"></div>
                </main>
            </div>
        `;
        const c = $('page-content');
        if(currentView === 'dashboard') renderDashboard(c);
        if(currentView === 'teachers_list') renderTeachersList(c);
        if(currentView === 'courses_list') renderCoursesList(c);
        if(currentView === 'calendar') renderCalendar(c);
        if(currentView === 'course') renderCourse(c);
        if(currentView === 'exam-take') renderExamTake(c);
        if(currentView === 'exam-review') renderExamReview(c);
        if(currentView === 'settings') renderSettings(c);
    }
}

// Global Nav Handlers
window.goDashboard = () => { currentView = 'dashboard'; render(); }
window.goTeachersList = () => { currentView = 'teachers_list'; render(); }
window.goCoursesList = () => { currentView = 'courses_list'; render(); }
window.goCalendar = () => { currentView = 'calendar'; render(); }
window.goSettings = () => { currentView = 'settings'; render(); }
window.logout = () => { currentUser = null; currentView = 'login'; selectedLoginRole = null; render(); }
window.render = render; // Expose render for inline calls

/**
 * ------------------------------------------------------------------
 * AUTH & LOGIN
 * ------------------------------------------------------------------
 */
function renderLogin(c) {
    c.innerHTML = `
        <div class="flex h-screen w-full bg-[#2D3B45] items-center justify-center">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
                <i class="fas fa-shapes text-5xl text-canvas-accent mb-6 inline-block"></i>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EduTrack LMS</h1>
                <p class="text-gray-500 mb-8" id="login-subtext">Select your portal to continue</p>
                
                <div id="role-selector" class="space-y-4 animate-fade-in">
                    <button onclick="showLoginForm('teacher')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm">
                        <div class="bg-blue-100 text-blue-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition text-lg"><i class="fas fa-chalkboard-teacher"></i></div>
                        <div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Teacher Login</span><span class="text-xs text-gray-400">Faculty access & management</span></div>
                    </button>
                    <button onclick="showLoginForm('student')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm">
                        <div class="bg-green-100 text-green-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition text-lg"><i class="fas fa-user-graduate"></i></div>
                        <div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Student Login</span><span class="text-xs text-gray-400">Access courses</span></div>
                    </button>
                    <button onclick="showLoginForm('admin')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm">
                        <div class="bg-purple-100 text-purple-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition text-lg"><i class="fas fa-user-shield"></i></div>
                        <div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Admin Login</span><span class="text-xs text-gray-400">System config</span></div>
                    </button>
                </div>

                <div id="login-form-box" class="hidden text-left animate-fade-in">
                    <div class="flex items-center mb-6">
                        <button onclick="hideLoginForm()" class="text-gray-400 hover:text-gray-600 mr-3 p-2 rounded-full hover:bg-gray-100 transition"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold text-gray-800" id="form-role-title">Login</h2>
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Username</label><input id="login-user" type="text" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:outline-none focus:border-canvas-accent transition"></div>
                        <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Password</label><input id="login-pass" type="password" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:outline-none focus:border-canvas-accent transition"></div>
                        <button onclick="loginAttempt()" class="w-full bg-canvas-accent text-white font-bold py-3.5 rounded-lg hover:bg-blue-700 transition shadow-lg mt-2">Sign In</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

window.showLoginForm = (role) => {
    selectedLoginRole = role;
    const titleMap = { 'teacher': 'Teacher Portal', 'student': 'Student Portal', 'admin': 'Administrator' };
    $('role-selector').classList.add('hidden');
    $('login-subtext').classList.add('hidden');
    $('login-form-box').classList.remove('hidden');
    $('form-role-title').innerText = titleMap[role];
    setTimeout(() => $('login-user').focus(), 100);
}

window.hideLoginForm = () => {
    selectedLoginRole = null;
    $('role-selector').classList.remove('hidden');
    $('login-subtext').classList.remove('hidden');
    $('login-form-box').classList.add('hidden');
    $('login-user').value = '';
    $('login-pass').value = '';
}

window.loginAttempt = () => {
    const u = $('login-user').value.toLowerCase().trim();
    const p = $('login-pass').value.trim();
    const user = db.users.find(x => x.username === u);
    
    if(user && user.password === p) {
        if (selectedLoginRole && user.role !== selectedLoginRole) {
            showToast(`This account is not a ${selectedLoginRole}.`, 'error');
            return;
        }
        currentUser = user; 
        goDashboard(); 
    } else {
        showToast('Invalid Username or Password', 'error');
    }
}

/**
 * ------------------------------------------------------------------
 * DASHBOARD (ADMIN NEWS)
 * ------------------------------------------------------------------
 */
function renderDashboard(c) {
    $('page-title').innerText = 'Dashboard';
    
    // --- ADMIN VIEW ---
    if(currentUser.role === 'admin') {
        c.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Post Creator -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded shadow border border-gray-200 sticky top-4">
                        <h3 class="font-bold text-lg mb-4 text-gray-800">Post Global Announcement</h3>
                        <div class="space-y-3">
                            <input id="gp-title" class="w-full border p-2 rounded text-sm" placeholder="Title">
                            <textarea id="gp-content" class="w-full border p-2 rounded text-sm h-24" placeholder="Announcement body..."></textarea>
                            <select id="gp-type" class="w-full border p-2 rounded text-sm bg-gray-50" onchange="toggleAdminMedia()">
                                <option value="text">Text Only</option>
                                <option value="image_upload">Image (Upload Poster)</option>
                                <option value="image_url">Image (URL)</option>
                                <option value="video">Video (YouTube)</option>
                            </select>
                            <input id="gp-url" class="w-full border p-2 rounded text-sm hidden" placeholder="Media URL...">
                            <div id="gp-file-container" class="hidden">
                                <label class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                                    <input type="file" id="gp-file" accept="image/*" class="w-full">
                                </label>
                            </div>
                            <button onclick="publishGlobalPost()" class="w-full bg-canvas-accent text-white py-2 rounded font-bold hover:bg-blue-700">Publish</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded shadow border border-gray-200 mt-6">
                        <h3 class="font-bold text-lg mb-4 text-gray-800">Register Teacher</h3>
                        <div class="space-y-3">
                            <input id="reg-t-name" class="w-full border p-2 rounded text-sm" placeholder="Full Name">
                            <input id="reg-t-user" class="w-full border p-2 rounded text-sm" placeholder="Username">
                            <input id="reg-t-pass" class="w-full border p-2 rounded text-sm" placeholder="Password">
                            <button onclick="registerTeacher()" class="w-full bg-canvas-success text-white py-2 rounded font-bold">Create Account</button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <h3 class="font-bold text-gray-500 uppercase text-xs mb-4">Active Global Posts</h3>
                    <div class="space-y-6">
                        ${(db.globalPosts || []).length === 0 ? '<p class="text-gray-400">No active posts.</p>' : ''}
                        ${(db.globalPosts || []).map(p => renderPostCard(p, true)).join('')}
                    </div>
                </div>
            </div>
        `;
        setTimeout(() => {
            const fileInput = document.getElementById('gp-file');
            if(fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(evt) { tempPostImage = evt.target.result; };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }, 500);
        return;
    }

    c.innerHTML = `
        <div class="max-w-4xl mx-auto">
            <div class="mb-4 flex items-center gap-2">
                <div class="bg-canvas-accent text-white p-2 rounded"><i class="fas fa-newspaper"></i></div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">School News & Announcements</h2>
                    <p class="text-gray-500 text-sm">Latest updates from the administration.</p>
                </div>
            </div>
            
            <div class="space-y-6">
                ${(db.globalPosts && db.globalPosts.length > 0) 
                    ? db.globalPosts.map(p => renderPostCard(p, false)).join('')
                    : '<div class="bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-inbox text-4xl mb-3 block"></i>No announcements yet.</div>'
                }
            </div>
        </div>
    `;
}

/**
 * ------------------------------------------------------------------
 * ADMIN: TEACHERS LIST
 * ------------------------------------------------------------------
 */
function renderTeachersList(c) {
    if(currentUser.role !== 'admin') return goDashboard();
    $('page-title').innerText = 'Teachers Directory';

    const teachers = db.users.filter(u => u.role === 'teacher').sort((a,b) => b.id.localeCompare(a.id));

    let html = `
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-gray-800 text-lg">Registered Teachers (${teachers.length})</h3>
        </div>
        <div class="bg-white border rounded shadow-sm overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b">
                    <tr><th class="p-4">Name</th><th class="p-4">Username</th><th class="p-4">Password</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    ${teachers.length === 0 ? '<tr><td colspan="5" class="p-4 text-center text-gray-400">No teachers found.</td></tr>' : ''}
                    ${teachers.map(t => `
                        <tr class="hover:bg-gray-50">
                            <td class="p-4 font-bold text-gray-800 flex items-center gap-3">
                                ${renderAvatar(t, 'w-8 h-8', 'text-xs')}
                                ${t.name}
                            </td>
                            <td class="p-4 font-mono text-gray-600">${t.username}</td>
                            <td class="p-4 font-mono text-gray-400 text-xs">${t.password}</td>
                            <td class="p-4"><span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">Active</span></td>
                            <td class="p-4 text-right"><button onclick="deleteUser('${t.id}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    c.innerHTML = html;
}

window.deleteUser = (uid) => {
    showConfirm('Are you sure you want to delete this user? This action cannot be undone.', () => {
        db.users = db.users.filter(u => u.id !== uid);
        saveDB(); render(); showToast('User deleted', 'error');
    });
}

/**
 * ------------------------------------------------------------------
 * SETTINGS VIEW
 * ------------------------------------------------------------------
 */
function renderSettings(c) {
    $('page-title').innerText = 'Account Settings';
    let html = `
        <div class="max-w-2xl mx-auto space-y-8">
            <div class="bg-white p-6 rounded shadow border border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Profile Picture</h3>
                <div class="flex items-center gap-4">
                    <div id="settings-avatar-preview">${renderAvatar(currentUser, 'w-16 h-16', 'text-2xl')}</div>
                    <div class="flex-1">
                        <input type="file" id="profile-pic-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="text-xs text-gray-400 mt-1">Recommended: Square JPG/PNG</p>
                    </div>
                    <button onclick="saveProfilePic()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm">Upload</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded shadow border border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Security</h3>
                <div class="space-y-4">
                    <div><label class="block text-sm font-bold text-gray-500 mb-1">New Password</label><input type="password" id="set-new-pass" class="w-full border p-2 rounded" placeholder="Enter new password"></div>
                    <button onclick="updatePassword()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm">Update Password</button>
                </div>
            </div>
    `;
    if(currentUser.role === 'teacher') {
        const myCourses = db.subjects.filter(s => s.teacherId === currentUser.id);
        html += `
            <div class="bg-white p-6 rounded shadow border border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">My Course Details</h3>
                <div class="space-y-4">
                    ${myCourses.map(s => `
                        <div class="border rounded p-4 bg-gray-50">
                            <h4 class="font-bold text-canvas-accent mb-2">${s.name} (${s.code})</h4>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input id="edit-name-${s.id}" value="${s.name}" class="border p-1 rounded text-sm" placeholder="Name">
                                <input id="edit-code-${s.id}" value="${s.code}" class="border p-1 rounded text-sm" placeholder="Code">
                            </div>
                            <input id="edit-intro-${s.id}" value="${s.introTitle || ''}" class="w-full border p-1 rounded text-sm mb-2" placeholder="Intro Title">
                            <button onclick="updateCourseDetails('${s.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Save Changes</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    html += `</div>`;
    c.innerHTML = html;
}

window.saveProfilePic = () => {
    const fileInput = document.getElementById('profile-pic-upload');
    const file = fileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Find current user in db.users to update ref
            const u = db.users.find(x => x.id === currentUser.id);
            if(u) {
                u.avatar = e.target.result; // Save base64
                saveDB();
                render();
                showToast('Profile picture updated!');
            }
        };
        reader.readAsDataURL(file);
    } else {
        showToast('Please select an image', 'error');
    }
}

window.updatePassword = () => {
    const newP = $('set-new-pass').value;
    if(!newP) return showToast('Enter a password', 'error');
    const u = db.users.find(x => x.id === currentUser.id);
    u.password = newP;
    saveDB(); showToast('Password Updated Successfully');
}

window.updateCourseDetails = (sid) => {
    const s = db.subjects.find(x => x.id === sid);
    s.name = $(`edit-name-${sid}`).value;
    s.code = $(`edit-code-${sid}`).value;
    s.introTitle = $(`edit-intro-${sid}`).value;
    saveDB(); showToast('Course Details Saved');
}

window.registerTeacher = () => {
    const name = $('reg-t-name').value;
    const user = $('reg-t-user').value;
    const pass = $('reg-t-pass').value;
    if(name && user && pass) {
        db.users.push({ id: 'u'+Date.now(), name, username: user, password: pass, role: 'teacher', avatar: 'T' });
        saveDB(); $('reg-t-name').value=''; $('reg-t-user').value=''; $('reg-t-pass').value=''; showToast('Teacher Account Created');
    } else { showToast('All fields required', 'error'); }
}

window.registerStudent = () => {
    const name = $('reg-s-name').value;
    const user = $('reg-s-user').value;
    const pass = $('reg-s-pass').value;
    if(name && user && pass) {
        const newId = 'u'+Date.now();
        db.users.push({ id: newId, name, username: user, password: pass, role: 'student', avatar: 'S' });
        if (currentCourseId) {
            const s = db.subjects.find(x => x.id === currentCourseId);
            if (s) s.students.push(newId);
        }
        saveDB();
        toggleModal('modal-reg-student');
        render(); 
        showToast('Student Account Created & Enrolled');
    } else { showToast('All fields required', 'error'); }
}

/**
 * ------------------------------------------------------------------
 * COURSES LIST
 * ------------------------------------------------------------------
 */
function renderCoursesList(c) {
    $('page-title').innerText = 'Courses';
    let subs = [];
    let filterHtml = '';

    if (currentUser.role === 'admin') {
        const teachers = db.users.filter(u => u.role === 'teacher');
        filterHtml = `
            <select onchange="setAdminFilter(this.value)" class="border p-2 rounded bg-white text-sm">
                <option value="all">All Teachers</option>
                ${teachers.map(t => `<option value="${t.id}" ${adminCourseFilter===t.id?'selected':''}>${t.name}</option>`).join('')}
            </select>
        `;
        if (adminCourseFilter === 'all') { subs = db.subjects; } 
        else { subs = db.subjects.filter(s => s.teacherId === adminCourseFilter); }
    } else if (currentUser.role === 'teacher') {
        subs = db.subjects.filter(s => s.teacherId === currentUser.id);
    } else {
        subs = db.subjects.filter(s => s.students.includes(currentUser.id));
    }
    
    let html = ``;
    html += `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3><div class="flex gap-2">${filterHtml}${currentUser.role === 'teacher' ? `<button onclick="openAddCourseModal()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm shadow hover:bg-blue-700 transition"><i class="fas fa-plus mr-2"></i>New Course</button>` : ''}</div></div>`;

    if(subs.length === 0) {
        html += `<div class="bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-book-open text-4xl mb-3 block"></i><p>No courses found.</p></div>`;
    } else {
        html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
        subs.forEach(s => {
            const t = db.users.find(u => u.id === s.teacherId);
            html += `
            <div onclick="openCourse('${s.id}')" class="course-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-pointer h-64 flex flex-col group">
                <div class="course-header" style="background-image: url('${s.img}'); background-color: ${s.color}"><div class="absolute inset-0 bg-black/30 p-4 transition group-hover:bg-black/40"><span class="bg-white/90 text-xs font-bold px-2 py-1 rounded w-max text-gray-800 shadow-sm">${s.code}</span></div></div>
                <div class="p-4 flex-1 flex flex-col justify-between"><div><h3 class="font-bold text-canvas-accent text-lg leading-tight mb-1 group-hover:underline">${s.name}</h3><p class="text-xs text-gray-500">${t ? t.name : 'Unknown Instructor'}</p></div><div class="flex items-center justify-between text-gray-400 text-sm"><span class="text-xs bg-gray-100 px-2 py-1 rounded">${s.students.length} Students</span></div></div>
            </div>`;
        });
        html += `</div>`;
    }
    c.innerHTML = html;
}

window.setAdminFilter = (val) => {
    adminCourseFilter = val;
    render();
}

// Helper: Render a Post Card
function renderPostCard(p, isAdmin) {
    let mediaHtml = '';
    if(p.mediaType==='video' && p.mediaUrl) { let u=p.mediaUrl.replace('watch?v=','embed/'); mediaHtml=`<div class="embed-container mt-3"><iframe src="${u}" frameborder="0" allowfullscreen></iframe></div>`; }
    else if((p.mediaType==='image_url' || p.mediaType==='image_upload' || p.mediaType === 'gif') && p.mediaUrl) { mediaHtml=`<img src="${p.mediaUrl}" class="w-full h-auto rounded mt-3 border object-contain bg-black/5" style="max-height: 600px;">`; }

    return `
        <div class="bg-white p-6 rounded border border-gray-200 shadow-sm relative group">
            ${isAdmin ? `<button onclick="deleteGlobalPost('${p.id}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
            <div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 rounded-full bg-canvas-accent text-white flex items-center justify-center font-bold text-xs"><i class="fas fa-university"></i></div><div><h4 class="font-bold text-gray-800 text-lg">${p.title}</h4><p class="text-xs text-gray-500">Posted by Admin â€¢ ${new Date(p.date).toLocaleDateString()}</p></div></div>
            <div class="text-gray-700 mt-2 whitespace-pre-line">${p.content}</div>
            ${mediaHtml}
        </div>
    `;
}

// Admin Logic
window.toggleAdminMedia = () => {
    const t = $('gp-type').value;
    const urlInput = $('gp-url');
    const fileInput = $('gp-file-container');
    urlInput.classList.add('hidden');
    fileInput.classList.add('hidden');
    if(t === 'image_upload') fileInput.classList.remove('hidden');
    else if (t === 'image_url' || t === 'video') urlInput.classList.remove('hidden');
}

window.publishGlobalPost = () => {
    const title = $('gp-title').value;
    const content = $('gp-content').value;
    const type = $('gp-type').value;
    let url = $('gp-url').value;
    if(!title || !content) return showToast('Title and Content required', 'error');
    if (type === 'image_upload') {
        if (!tempPostImage) return showToast('Please upload an image', 'error');
        url = tempPostImage;
    }
    if(!db.globalPosts) db.globalPosts = [];
    db.globalPosts.unshift({ id: 'gp'+Date.now(), title, content, mediaType: type, mediaUrl: url, date: new Date().toISOString() });
    tempPostImage = null;
    saveDB(); render(); showToast('Announcement Posted');
}

window.deleteGlobalPost = (id) => {
    showConfirm('Delete announcement?', () => {
        db.globalPosts = db.globalPosts.filter(p => p.id !== id);
        saveDB(); render();
    });
}

window.openAddCourseModal = () => {
    renderModal('modal-add-course', 'Add Course', `
        <div class="space-y-3">
            <input id="c-name" class="w-full border p-2 rounded" placeholder="Course Name">
            <input id="c-code" class="w-full border p-2 rounded" placeholder="Course Code">
            <div>
                <label class="text-xs font-bold text-gray-500">Select Teacher</label>
                <select id="c-teacher" class="w-full border p-2 rounded bg-white text-sm">
                    ${db.users.filter(u => u.role === 'teacher').map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                </select>
            </div>
            <button onclick="addCourse()" class="w-full bg-canvas-accent text-white py-2 rounded">Create</button>
        </div>
    `);
}

window.addCourse = () => {
    const n = $('c-name').value;
    const c = $('c-code').value;
    let tid = currentUser.id;
    
    // If admin is creating, use selected teacher ID
    if (currentUser.role === 'admin') {
        tid = $('c-teacher').value;
    }

    if (n && c) {
        db.subjects.push({
            id: 's' + Date.now(),
            name: n,
            code: c,
            teacherId: tid,
            students: [],
            color: '#0374B5',
            img: '',
            introTitle: 'Welcome',
            introBody: '',
            gradingWeights: { ww: 40, pt: 40, qa: 20 }
        });
        saveDB();
        render();
        closeModal('modal-add-course');
    }
}
window.openCourse = (sid) => { currentCourseId = sid; currentView = 'course'; currentTab = 'home'; render(); }

/**
 * ------------------------------------------------------------------
 * CALENDAR
 * ------------------------------------------------------------------
 */
function renderCalendar(c) {
    $('page-title').innerText = 'Calendar';
    const year=calendarDate.getFullYear(), month=calendarDate.getMonth();
    const firstDay=new Date(year,month,1).getDay(), days=new Date(year,month+1,0).getDate();
    let html = `<div class="bg-white p-4 rounded shadow mb-4 flex justify-between"><button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button><h2 class="font-bold text-xl">${calendarDate.toLocaleString('default',{month:'long'})} ${year}</h2><button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button></div>`;
    html += `<div class="calendar-grid">${['S','M','T','W','T','F','S'].map(d=>`<div class="bg-gray-50 p-2 text-center text-xs font-bold">${d}</div>`).join('')}`;
    for(let i=0; i<firstDay; i++) html+=`<div class="cal-cell bg-gray-50/50"></div>`;
    for(let d=1; d<=days; d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        let evts = '';
        db.subjects.forEach(s => {
            if(currentUser.role==='student' && !s.students.includes(currentUser.id)) return;
            if(currentUser.role==='teacher' && s.teacherId!==currentUser.id) return;
            (db.exams[s.id]||[]).forEach(e => {
                if(e.dueDate.startsWith(dateStr)) evts += `<div class="event-pill" style="background:${s.color};color:white">Due: ${e.title}</div>`;
            });
            // Also show Manual Activities
            (db.activities[s.id]||[]).forEach(a => {
                if(a.date === dateStr) evts += `<div class="event-pill border border-gray-400 text-gray-600 bg-white">Task: ${a.title}</div>`;
            });
        });
        html += `<div class="cal-cell">${d}<div class="flex flex-col gap-1 mt-1">${evts}</div></div>`;
    }
    html += `</div>`;
    c.innerHTML = html;
}
window.changeMonth = (d) => { calendarDate.setMonth(calendarDate.getMonth()+d); render(); }

/**
 * ------------------------------------------------------------------
 * COURSE VIEW
 * ------------------------------------------------------------------
 */
function renderCourse(c) {
    const s = db.subjects.find(x => x.id === currentCourseId);
    if(!s) return goDashboard();
    $('page-title').innerHTML = `<span class="text-gray-400 cursor-pointer" onclick="goCoursesList()">${s.code}</span> <span class="mx-2">></span> ${s.name}`;

    c.innerHTML = `
        <div class="flex flex-col md:flex-row gap-6 h-full">
            <nav class="w-full md:w-48 flex-shrink-0 flex md:flex-col gap-1 text-sm font-medium text-canvas-primary border-r border-gray-200 pb-4 md:pr-4">
                <a onclick="switchCourseTab('home')" class="${currentTab==='home'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Home</a>
                <a onclick="switchCourseTab('activities')" class="${currentTab==='activities'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Activities</a>
                <a onclick="switchCourseTab('quizzes')" class="${currentTab==='quizzes'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Quizzes/Exams</a>
                <a onclick="switchCourseTab('grades')" class="${currentTab==='grades'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Grades</a>
                <a onclick="switchCourseTab('people')" class="${currentTab==='people'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">People</a>
            </nav>
            <div id="course-content" class="flex-1"></div>
        </div>
    `;
    renderCourseTab();
}
window.switchCourseTab = (t) => { currentTab=t; render(); }

function renderCourseTab() {
    const c = $('course-content');
    const s = db.subjects.find(x => x.id === currentCourseId);
    const isTeacher = currentUser.role === 'teacher' || currentUser.role === 'admin'; 
    const isAdmin = currentUser.role === 'admin';

    // --- HOME (FEED) ---
    if(currentTab === 'home') {
        const posts = (db.posts || [])
            .filter(p => p.courseId === s.id)
            .sort((a,b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                return new Date(b.date) - new Date(a.date);
            });
            
        c.innerHTML = `
            <div class="bg-white p-6 rounded border border-gray-200 mb-6 relative group">
                ${isTeacher ? `<button onclick="editIntro()" class="absolute top-4 right-4 text-gray-400 hover:text-canvas-accent"><i class="fas fa-edit"></i> Edit Info</button>` : ''}
                <h2 class="text-2xl font-bold text-gray-800 mb-2">${s.introTitle || `Welcome to ${s.name}`}</h2>
                <p class="text-gray-600 leading-relaxed">${s.introBody || 'No introduction provided yet.'}</p>
            </div>
            ${isTeacher ? `
            <div class="bg-white p-4 rounded border border-gray-200 mb-6 shadow-sm">
                <textarea id="post-content" class="w-full border p-3 rounded mb-2 text-sm focus:outline-none focus:border-canvas-accent" placeholder="Share an announcement..." rows="3"></textarea>
                <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                        <select id="post-type" class="border p-2 rounded text-sm bg-gray-50 flex-1" onchange="toggleMediaInput()">
                            <option value="text">Text Only</option>
                            <option value="link">Link</option>
                            <option value="video">Video</option>
                            <option value="image_upload">Image (Upload)</option>
                            <option value="image_url">Image (URL)</option>
                            <option value="gif">GIF (URL)</option>
                        </select>
                        <button onclick="publishPost()" class="bg-canvas-accent text-white px-6 py-2 rounded font-bold">Post</button>
                    </div>
                    
                    <input id="post-url" class="border p-2 rounded text-sm hidden" placeholder="Paste URL here...">
                    
                    <div id="post-file-container" class="hidden border border-dashed border-gray-300 p-2 rounded bg-gray-50">
                        <input type="file" id="post-file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    </div>
                </div>
            </div>` : ''}
            <div class="space-y-6">
                ${posts.map(p => {
                    let mediaHtml = '';
                    if(p.mediaType==='video' && p.mediaUrl) { let u=p.mediaUrl.replace('watch?v=','embed/'); mediaHtml=`<div class="embed-container"><iframe src="${u}" frameborder="0"></iframe></div>`; }
                    else if(p.mediaType==='link') mediaHtml=`<a href="${p.mediaUrl}" target="_blank" class="block mt-2 bg-gray-50 p-3 rounded border text-canvas-accent font-bold"><i class="fas fa-link mr-2"></i> ${p.mediaUrl}</a>`;
                    else if((p.mediaType==='image' || p.mediaType==='image_url' || p.mediaType==='image_upload' || p.mediaType==='gif') && p.mediaUrl) {
                        mediaHtml = `<img src="${p.mediaUrl}" class="w-full h-auto rounded mt-3 border object-contain bg-black/5" style="max-height: 400px;">`;
                    }
                    
                    // Look up author for avatar
                    const author = db.users.find(u => u.id === p.authorId) || { name: p.authorName, avatar: '?' };

                    return `
                    <div class="bg-white p-6 rounded border border-gray-200 relative group ${p.isPinned ? 'bg-yellow-50 border-yellow-200' : ''}">
                        ${p.isPinned ? '<div class="absolute top-2 left-2 text-xs font-bold text-yellow-600"><i class="fas fa-thumbtack mr-1"></i> Pinned</div>' : ''}
                        
                        ${isTeacher ? `
                            <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="togglePinPost('${p.id}')" class="${p.isPinned ? 'text-canvas-accent' : 'text-gray-300 hover:text-canvas-accent'}">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                                <button onclick="deletePost('${p.id}')" class="text-gray-300 hover:text-red-500">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}

                        <div class="flex gap-3 mb-3 mt-4">
                            ${renderAvatar(author, 'w-10 h-10', 'text-sm')}
                            <div>
                                <p class="font-bold text-sm">${p.authorName}</p>
                                <p class="text-xs text-gray-500">${new Date(p.date).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="text-gray-700 whitespace-pre-line">${p.content}</div>
                        ${mediaHtml}
                    </div>`;
                }).join('')}
            </div>
        `;
        
        setTimeout(() => {
            const fileInput = document.getElementById('post-file');
            if(fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(evt) { tempTeacherImage = evt.target.result; };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }, 500);
    }

    // --- ACTIVITIES TAB (NEW) ---
    if(currentTab === 'activities') {
        const activities = db.activities[s.id] || [];
        
        let html = `
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Class Activities</h2>
                    <p class="text-gray-500 text-xs">Manual grading columns for Performance Tasks & Written Work</p>
                </div>
                ${isTeacher ? `<button onclick="openActivityModal()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm shadow hover:bg-blue-700 transition"><i class="fas fa-plus mr-2"></i>New Activity</button>` : ''}
            </div>
        `;

        if(activities.length === 0) {
            html += `<div class="bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-clipboard-list text-4xl mb-3 block"></i>No manual activities created yet.</div>`;
        } else {
            html += `<div class="grid grid-cols-1 gap-4">`;
            activities.forEach(a => {
                const badgeColor = a.category === 'pt' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700';
                const catName = a.category === 'pt' ? 'Performance Task' : 'Written Work';
                
                html += `
                <div class="bg-white p-4 rounded border flex justify-between items-center hover:bg-gray-50 transition cursor-pointer" onclick="openGradeActivityModal('${a.id}')">
                    <div class="flex items-center gap-4">
                         <div class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-pencil-ruler"></i></div>
                         <div>
                            <h4 class="font-bold text-gray-800 text-lg">${a.title}</h4>
                            <div class="flex gap-2 text-xs mt-1">
                                <span class="${badgeColor} px-2 py-0.5 rounded font-bold uppercase">${catName}</span>
                                <span class="text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Max Score: ${a.maxScore}</span>
                                <span class="text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${formatDate(a.date)}</span>
                            </div>
                         </div>
                    </div>
                    ${isTeacher ? `<button onclick="event.stopPropagation(); deleteActivity('${a.id}')" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>` : ''}
                </div>`;
            });
            html += `</div>`;
        }
        c.innerHTML = html;
    }

    // --- GRADES ---
    if(currentTab === 'grades') {
        const enrolled = db.users.filter(u => s.students.includes(u.id));
        const weights = s.gradingWeights || { ww: 40, pt: 40, qa: 20 };
        
        // --- CALCULATION LOGIC ---
        // 1. Get all gradeable items
        const quizzes = db.exams[s.id] || [];
        const activities = db.activities[s.id] || [];
        
        // 2. Separate by Category
        const wwItems = [...quizzes.filter(q => q.category !== 'qa'), ...activities.filter(a => a.category !== 'pt')];
        const ptItems = activities.filter(a => a.category === 'pt');
        const qaItems = quizzes.filter(q => q.category === 'qa');

        let html = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Class Record</h2>
                ${isTeacher ? `
                <div class="flex gap-2">
                    <button onclick="openWeightsModal()" class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-xs font-bold hover:bg-gray-200 border"><i class="fas fa-sliders-h mr-1"></i> Weights</button>
                    <button onclick="resetGrades()" class="bg-red-50 text-red-600 border border-red-200 px-3 py-1 rounded text-xs font-bold hover:bg-red-100"><i class="fas fa-exclamation-triangle mr-1"></i> Reset All Grades</button>
                </div>` : ''}
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                <div class="bg-orange-50 p-2 rounded border border-orange-100"><div class="text-xs font-bold text-orange-800">Written Work</div><div class="font-bold text-lg">${weights.ww}%</div></div>
                <div class="bg-purple-50 p-2 rounded border border-purple-100"><div class="text-xs font-bold text-purple-800">Performance Tasks</div><div class="font-bold text-lg">${weights.pt}%</div></div>
                <div class="bg-blue-50 p-2 rounded border border-blue-100"><div class="text-xs font-bold text-blue-800">Quarterly Assessment</div><div class="font-bold text-lg">${weights.qa}%</div></div>
            </div>

            <div class="overflow-x-auto bg-white border rounded shadow-sm">
                <table class="w-full text-left text-sm grade-table">
                    <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b">
                        <tr>
                            <th class="p-4 sticky left-0 bg-gray-50 z-10 border-r">Student</th>
                            <th class="p-4 text-center bg-orange-50/50">WW Total</th>
                            <th class="p-4 text-center bg-purple-50/50">PT Total</th>
                            <th class="p-4 text-center bg-blue-50/50">QA Total</th>
                            <th class="p-4 text-center bg-gray-100 text-gray-800">Initial Grade</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
        `;
        
        enrolled.forEach(stu => {
            // Helper to calc component score
            const calcComponent = (items, type) => {
                let totalScore = 0;
                let totalMax = 0;
                
                items.forEach(item => {
                    let score = 0;
                    let max = 0;
                    
                    if (item.questions) { 
                        // It's a Quiz
                        max = item.questions.length; // 1 pt per question default
                        const sub = db.examSubmissions[item.id]?.[stu.id];
                        if (sub && sub.score !== undefined) {
                            // sub.score is percentage, convert back to raw or just assume max=100 for percent
                            // Actually, standardizing: Quizzes store raw answers. sub.score is %.
                            // Let's use percentage directly to normalize
                            score = sub.score; 
                            max = 100;
                        }
                    } else {
                        // It's an Activity
                        max = parseInt(item.maxScore);
                        const s = db.activitySubmissions[item.id]?.[stu.id];
                        score = s ? parseInt(s) : 0;
                    }
                    
                    totalScore += score;
                    totalMax += max;
                });
                
                if (totalMax === 0) return 0;
                return (totalScore / totalMax) * 100;
            };

            const wwPct = calcComponent(wwItems);
            const ptPct = calcComponent(ptItems);
            const qaPct = calcComponent(qaItems);
            
            const initialGrade = (wwPct * (weights.ww/100)) + (ptPct * (weights.pt/100)) + (qaPct * (weights.qa/100));
            const transmuted = initialGrade; // DepEd usually transmutes this, keeping raw for MVP

            html += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 font-bold text-gray-700 sticky left-0 bg-white border-r">
                        <div class="flex items-center gap-2">
                             ${renderAvatar(stu, 'w-6 h-6', 'text-[10px]')}
                             ${stu.name}
                        </div>
                    </td>
                    <td class="p-4 text-center text-orange-700 font-mono bg-orange-50/20">${Math.round(wwPct)}%</td>
                    <td class="p-4 text-center text-purple-700 font-mono bg-purple-50/20">${Math.round(ptPct)}%</td>
                    <td class="p-4 text-center text-blue-700 font-mono bg-blue-50/20">${Math.round(qaPct)}%</td>
                    <td class="p-4 text-center font-bold text-gray-800 bg-gray-50 text-base">${Math.round(initialGrade)}</td>
                </tr>
            `;
        });
        html += `</tbody></table></div>`;
        c.innerHTML = html;
    }

    // --- QUIZZES ---
    if(currentTab === 'quizzes') {
        const exams = db.exams[s.id] || [];
        let html = `
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Quizzes & Exams</h2>
                    <p class="text-xs text-gray-500">Auto-graded assessments</p>
                </div>
                ${isTeacher ? `<div class="flex gap-2"><button onclick="openImportModal()" class="bg-white border text-gray-700 px-3 py-1 rounded text-sm font-bold"><i class="fas fa-file-word"></i> Import DOCX</button><button onclick="openCreateModal()" class="bg-canvas-accent text-white px-3 py-1 rounded text-sm font-bold"><i class="fas fa-plus"></i> Manual</button></div>` : ''}
            </div>
            <div class="space-y-3">
                ${exams.map(e => {
                    const sub = db.examSubmissions[e.id]?.[currentUser.id];
                    const attemptsAllowed = e.attempts || 1;
                    const attemptsTaken = sub ? (sub.attemptsTaken || 0) : 0;
                    const isAttemptLocked = attemptsTaken >= attemptsAllowed;
                    
                    const now = new Date();
                    const openDate = new Date(e.openDate);
                    const dueDate = new Date(e.dueDate);
                    const isUpcoming = now < openDate;
                    const isClosed = now > dueDate;
                    const catBadge = e.category === 'qa' ? '<span class="bg-blue-100 text-blue-800 text-[10px] px-1 rounded font-bold uppercase ml-2">Quarterly Exam</span>' : '<span class="bg-orange-100 text-orange-800 text-[10px] px-1 rounded font-bold uppercase ml-2">Written Work</span>';

                    let actionBtn = '';
                    
                    if(isTeacher || isAdmin) {
                        actionBtn = `<div class="flex gap-2">
                            <button onclick="showItemAnalysis('${e.id}')" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200" title="Analytics"><i class="fas fa-chart-bar"></i></button>
                            <button onclick="reviewExamContent('${e.id}')" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200" title="Review Content"><i class="fas fa-eye"></i></button>
                            <button onclick="openCreateModal('${e.id}')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100" title="Edit Exam"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="deleteExam('${e.id}')" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>`;
                    } else {
                        if (isUpcoming) {
                            actionBtn = `<span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded font-medium"><i class="fas fa-lock mr-1"></i> Opens ${formatDate(e.openDate)}</span>`;
                        } else if (isClosed && !sub) {
                            actionBtn = `<span class="text-xs text-red-500 font-bold border border-red-200 px-3 py-1 rounded">Closed</span>`;
                        } else if (isAttemptLocked || (isClosed && sub)) {
                            actionBtn = `<button onclick="reviewExam('${e.id}')" class="bg-gray-100 text-gray-700 border border-gray-300 px-3 py-1 rounded text-xs font-bold hover:bg-gray-200">Review Results</button>`;
                        } else {
                            actionBtn = `<button onclick="startExam('${e.id}')" class="bg-canvas-accent text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-blue-700">Take Quiz</button>`;
                        }
                    }

                    return `
                    <div class="bg-white p-4 border rounded flex justify-between items-center hover:bg-gray-50 transition">
                        <div class="flex gap-4 items-center">
                            <div class="text-2xl text-gray-400"><i class="fas fa-rocket"></i></div>
                            <div>
                                <h4 class="font-bold hover:underline cursor-pointer text-canvas-primary">${e.title} ${catBadge}</h4>
                                <div class="text-xs text-gray-500 flex gap-3 mt-1">
                                    <span title="Due Date"><i class="far fa-calendar-times"></i> ${formatDate(e.dueDate)}</span>
                                    <span title="Time Limit"><i class="far fa-clock"></i> ${e.timeLimit} mins</span>
                                    <span title="Questions"><i class="fas fa-list-ol"></i> ${e.questions.length} Qs</span>
                                    <span title="Attempts"><i class="fas fa-redo"></i> ${attemptsTaken}/${attemptsAllowed}</span>
                                </div>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>
                `}).join('')}
            </div>
        `;
        c.innerHTML = html;
    }

    // --- PEOPLE ---
    if(currentTab === 'people') {
        const enrolled = db.users.filter(u => s.students.includes(u.id));
        const teacher = db.users.find(u => u.id === s.teacherId);
        
        let html = `<div class="flex justify-between items-center mb-6 border-b pb-4"><h2 class="text-xl font-bold">People</h2>`;
        
        // Add buttons for Teachers
        if(isTeacher) {
            html += `<div class="flex gap-2"><button onclick="openRegisterStudentModal()" class="bg-white border text-gray-600 px-3 py-1 rounded text-sm font-bold shadow-sm">Register New Student</button><button onclick="openAddStudentModal()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm">Enroll Existing</button></div>`;
        }
        html += `</div>`;

        // Table Headers
        let headers = `<tr><th class="p-4">Name</th><th class="p-4">Role</th>`;
        if(isTeacher) {
            headers += `<th class="p-4">Username</th><th class="p-4">Password</th><th class="p-4 text-right">Action</th>`;
        }
        headers += `</tr>`;

        html += `<div class="bg-white border rounded overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 border-b text-xs uppercase font-bold text-gray-500">${headers}</thead><tbody class="divide-y">`;
        
        // Teacher Row
        html += `<tr><td class="p-4 flex items-center gap-2 font-bold">${renderAvatar(teacher, 'w-6 h-6', 'text-[10px]')} ${teacher ? teacher.name : 'Unknown'}</td><td class="p-4">Teacher</td>`;
        if(isTeacher) {
            html += `<td class="p-4 font-mono text-gray-400">-</td><td class="p-4 font-mono text-gray-400">-</td><td class="p-4"></td>`;
        }
        html += `</tr>`;

        // Student Rows
        html += enrolled.map(u => {
            let row = `<tr><td class="p-4 flex items-center gap-2">${renderAvatar(u, 'w-6 h-6', 'text-[10px]')} ${u.name}</td><td class="p-4">Student</td>`;
            if(isTeacher) {
                row += `<td class="p-4 font-mono text-blue-600">${u.username}</td>
                        <td class="p-4 font-mono text-red-500">${u.password}</td>
                        <td class="p-4 text-right">
                            <button onclick="removeStudentFromCourse('${s.id}', '${u.id}')" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition" title="Remove from Course">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </td>`;
            }
            row += `</tr>`;
            return row;
        }).join('');
        
        html += `</tbody></table></div>`;
        c.innerHTML = html;
    }
}

// Course Feed Actions (New)
window.deletePost = (pid) => {
    showConfirm('Delete this post?', () => {
        db.posts = db.posts.filter(p => p.id !== pid);
        saveDB();
        render();
        showToast('Post deleted', 'error');
    });
}

window.togglePinPost = (pid) => {
    const p = db.posts.find(post => post.id === pid);
    if(p) {
        p.isPinned = !p.isPinned;
        saveDB();
        render();
        showToast(p.isPinned ? 'Post Pinned' : 'Post Unpinned');
    }
}

window.removeStudentFromCourse = (sid, uid) => {
    showConfirm('Are you sure you want to remove this student from the course?', () => {
        const s = db.subjects.find(x => x.id === sid);
        if(s) {
            s.students = s.students.filter(id => id !== uid);
            saveDB();
            render();
            showToast('Student removed from course');
        }
    });
}

// Helper to convert questions back to text for editing
function questionsToText(questions) {
    let textOutput = "";
    let lastPassage = "";
    
    questions.forEach((q, i) => {
        // If passage changed, print it
        if (q.passage && q.passage !== lastPassage) {
            textOutput += `\n${q.passage}\n\n`;
            lastPassage = q.passage;
        }
        
        textOutput += `${i+1}. ${q.q}\n`;
        q.options.forEach((opt, idx) => {
            textOutput += `${String.fromCharCode(65+idx)}. ${opt}\n`;
        });
        textOutput += `Answer: ${String.fromCharCode(65+q.ans)}\n\n`;
    });
    
    return textOutput.trim();
}

// Unified Create/Edit Exam Logic
window.saveExam = (existingId = null) => { 
    const t=$('q-title').value, o=$('q-open').value, d=$('q-due').value, att=$('q-attempts').value, limit=$('q-timelimit').value, cat=$('q-cat').value, content=$('q-content').value; 
    
    if(t&&o&&d) { 
        let questions = [];
        if (content && content.trim() !== "") {
            questions = parseQuizText(content);
        } else {
             questions = [{q:'Sample Question?', options:['Yes','No'], ans:0}];
        }
        
        if(!db.exams[currentCourseId]) db.exams[currentCourseId]=[]; 
        
        const examData = {
            id: existingId || 'e'+Date.now(), 
            title: t, 
            openDate: o, 
            dueDate: d, 
            timeLimit: parseInt(limit) || 30, 
            attempts: parseInt(att) || 1, 
            category: cat,
            questions: questions
        };

        if (existingId) {
            // Update existing
            const idx = db.exams[currentCourseId].findIndex(e => e.id === existingId);
            if (idx !== -1) db.exams[currentCourseId][idx] = examData;
        } else {
            // Create new
            db.exams[currentCourseId].push(examData);
        }
        
        saveDB(); 
        closeModal('modal-create-quiz'); 
        render(); 
        showToast(existingId ? 'Exam Updated' : 'Exam Created'); 
    } else {
        showToast('Please fill in Title, Start Date, and Due Date.', 'error');
    }
}

// Updated Modal Opener to handle Edit Mode
window.openCreateModal = (examId = null) => { 
    let exam = { title: '', openDate: '', dueDate: '', timeLimit: 30, attempts: 1, category: 'ww' };
    let content = '';
    let titleText = 'Create Quiz / Exam';
    let btnText = 'Publish';

    if (examId) {
        exam = db.exams[currentCourseId].find(e => e.id === examId);
        if (exam) {
            content = questionsToText(exam.questions);
            titleText = 'Edit Exam';
            btnText = 'Save Changes';
        }
    }

    renderModal('modal-create-quiz', titleText, `
        <div class="space-y-3">
            <input id="q-title" class="w-full border p-2 mb-2 rounded" placeholder="Title" value="${exam.title}">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <div><label class="text-xs font-bold text-gray-500">Start</label><input id="q-open" type="datetime-local" class="border p-2 w-full rounded" value="${exam.openDate}"></div>
                <div><label class="text-xs font-bold text-gray-500">Due</label><input id="q-due" type="datetime-local" class="border p-2 w-full rounded" value="${exam.dueDate}"></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <div><label class="text-xs font-bold text-gray-500">Time Limit (mins)</label><input id="q-timelimit" type="number" class="border p-2 w-full rounded" value="${exam.timeLimit}"></div>
                <div><label class="text-xs font-bold text-gray-500">Allowed Attempts</label><input id="q-attempts" type="number" class="border p-2 w-full rounded" value="${exam.attempts}"></div>
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500">Category (DepEd Grading)</label>
                <select id="q-cat" class="w-full border p-2 rounded bg-white">
                    <option value="ww" ${exam.category!=='qa'?'selected':''}>Written Work (Quiz)</option>
                    <option value="qa" ${exam.category==='qa'?'selected':''}>Quarterly Assessment (Exam)</option>
                </select>
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500">Questions (Standard Format)</label>
                <textarea id="q-content" class="w-full border p-2 rounded h-64 text-sm font-mono leading-relaxed" placeholder="1. Question...\nA. Option\nB. Option\nAnswer: A" oninput="window.onManualInput(this.value)">${content}</textarea>
                <p id="manual-detected-label" class="text-xs mt-1 text-right text-gray-400">Type or paste questions above...</p>
            </div>
            <button onclick="saveExam('${examId || ''}')" class="w-full bg-canvas-accent text-white py-2 font-bold rounded">${btnText}</button>
        </div>
    `); 
    
    // Trigger detection immediately if editing
    if (content) window.onManualInput(content);
}

// --- ACTIVITIES LOGIC (NEW) ---
window.openActivityModal = () => {
    renderModal('modal-activity', 'New Class Activity', `
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Title</label>
                <input id="act-title" class="w-full border p-2 rounded" placeholder="e.g. Science Experiment">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Category</label>
                    <select id="act-cat" class="w-full border p-2 rounded bg-white">
                        <option value="pt">Performance Task</option>
                        <option value="ww">Written Work</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Max Score</label>
                    <input id="act-max" type="number" class="w-full border p-2 rounded" value="100">
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Date</label>
                <input id="act-date" type="date" class="w-full border p-2 rounded" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <button onclick="saveActivity()" class="w-full bg-canvas-accent text-white py-2 font-bold rounded">Create Column</button>
        </div>
    `);
}

window.saveActivity = () => {
    const title = $('act-title').value;
    const cat = $('act-cat').value;
    const max = parseInt($('act-max').value);
    const date = $('act-date').value;
    
    if(title && max) {
        if(!db.activities[currentCourseId]) db.activities[currentCourseId] = [];
        db.activities[currentCourseId].push({
            id: 'a'+Date.now(),
            title, category: cat, maxScore: max, date
        });
        saveDB();
        closeModal('modal-activity');
        render();
        showToast('Activity Created');
    }
}

window.openGradeActivityModal = (aid) => {
    const s = db.subjects.find(x => x.id === currentCourseId);
    const act = db.activities[currentCourseId].find(a => a.id === aid);
    const students = db.users.filter(u => s.students.includes(u.id));
    
    // Check if user is teacher to edit, or view only
    if(currentUser.role !== 'teacher' && currentUser.role !== 'admin') {
        const score = db.activitySubmissions[aid]?.[currentUser.id];
        return renderModal('modal-grade-view', act.title, `
            <div class="text-center p-6">
                <p class="text-gray-500">Your Score</p>
                <h1 class="text-4xl font-bold text-canvas-accent mb-2">${score || '-'} <span class="text-xl text-gray-400">/ ${act.maxScore}</span></h1>
                <span class="px-3 py-1 bg-gray-100 rounded text-xs font-bold uppercase">${act.category === 'pt' ? 'Performance Task' : 'Written Work'}</span>
            </div>
        `);
    }

    let html = `
        <div class="mb-4 flex justify-between items-center bg-gray-50 p-3 rounded">
            <div>
                <p class="text-xs font-bold text-gray-500">Max Score: ${act.maxScore}</p>
                <p class="text-xs font-bold text-gray-500">Type: ${act.category.toUpperCase()}</p>
            </div>
        </div>
        <div class="max-h-[50vh] overflow-y-auto space-y-2 border-t pt-2">
            ${students.map(stu => {
                const score = db.activitySubmissions[aid]?.[stu.id] || '';
                return `
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 border-b">
                    <span class="font-bold text-gray-700 text-sm">${stu.name}</span>
                    <input type="number" 
                        class="border rounded p-1 w-20 text-center" 
                        max="${act.maxScore}" 
                        value="${score}" 
                        onchange="updateActivityGrade('${aid}', '${stu.id}', this.value)"
                    >
                </div>
                `;
            }).join('')}
        </div>
    `;
    renderModal('modal-grade-act', `Grading: ${act.title}`, html);
}

window.updateActivityGrade = (aid, uid, val) => {
    if(!db.activitySubmissions[aid]) db.activitySubmissions[aid] = {};
    db.activitySubmissions[aid][uid] = parseInt(val);
    saveDB();
    // Re-render handled by modal persistence (no need to full render until close)
}

window.deleteActivity = (aid) => {
    showConfirm('Delete this activity and all student grades for it?', () => {
        db.activities[currentCourseId] = db.activities[currentCourseId].filter(a => a.id !== aid);
        delete db.activitySubmissions[aid]; // Clean up grades
        saveDB();
        render();
        showToast('Activity Deleted', 'error');
    });
}

// --- GRADING WEIGHTS ---
window.openWeightsModal = () => {
    const s = db.subjects.find(x => x.id === currentCourseId);
    const w = s.gradingWeights || { ww: 40, pt: 40, qa: 20 };
    renderModal('modal-weights', 'Grading System Weights', `
        <div class="space-y-4">
            <p class="text-xs text-gray-500">Set the percentage weight for each component (Must total 100%).</p>
            <div class="grid grid-cols-3 gap-2">
                <div><label class="text-xs font-bold">Written Work (%)</label><input id="w-ww" type="number" class="border p-2 w-full rounded" value="${w.ww}"></div>
                <div><label class="text-xs font-bold">Perf. Task (%)</label><input id="w-pt" type="number" class="border p-2 w-full rounded" value="${w.pt}"></div>
                <div><label class="text-xs font-bold">Quarterly Assess (%)</label><input id="w-qa" type="number" class="border p-2 w-full rounded" value="${w.qa}"></div>
            </div>
            <button onclick="saveWeights()" class="w-full bg-canvas-accent text-white py-2 font-bold rounded">Save Configuration</button>
        </div>
    `);
}

window.saveWeights = () => {
    const ww = parseInt($('w-ww').value);
    const pt = parseInt($('w-pt').value);
    const qa = parseInt($('w-qa').value);
    
    if (ww + pt + qa !== 100) return showToast('Weights must total 100%', 'error');
    
    const s = db.subjects.find(x => x.id === currentCourseId);
    s.gradingWeights = { ww, pt, qa };
    saveDB();
    closeModal('modal-weights');
    render();
    showToast('Grading System Updated');
}

window.resetGrades = () => {
    showConfirm('âš ï¸ WARNING: This will delete ALL grades (Exam results & Activity scores) for this course. This cannot be undone.', () => {
        // Clear Activity Grades
        const activities = db.activities[currentCourseId] || [];
        activities.forEach(a => {
            if (db.activitySubmissions[a.id]) delete db.activitySubmissions[a.id];
        });
        
        // Clear Exam Grades
        const exams = db.exams[currentCourseId] || [];
        exams.forEach(e => {
            if (db.examSubmissions[e.id]) delete db.examSubmissions[e.id];
        });
        
        saveDB();
        render();
        showToast('All grades have been reset.', 'error');
    });
}

// Updated Import Modal with Time Limit
window.openImportModal = () => { 
    renderModal('modal-import', 'Import DOCX Exam', `
        <div class="space-y-4">
            <div class="bg-blue-50 p-2 text-xs rounded text-blue-800">
                <b>Supported Formats:</b><br>1. Standard (1. Question A. Option Answer: A)<br>2. Passage (For items 1-5: [Story] 1. Question...)
            </div>
            
            <button onclick="downloadTemplate()" class="text-xs underline text-canvas-accent">Download Template File</button>
            
            <input type="file" id="docx-upload" accept=".docx" class="w-full text-sm border p-2 rounded">
            
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-xs font-bold text-gray-500">Open Date</label>
                    <input id="imp-open" type="datetime-local" class="border p-2 w-full rounded text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Due/Lock Date</label>
                    <input id="imp-due" type="datetime-local" class="border p-2 w-full rounded text-sm">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-xs font-bold text-gray-500">Time Limit (Mins)</label>
                    <input id="imp-timelimit" type="number" class="border p-2 w-full rounded" value="30">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Attempts</label>
                    <input id="imp-attempts" type="number" class="border p-2 w-full rounded" value="1" min="1">
                </div>
            </div>

            <div id="parse-preview" class="hidden text-xs bg-gray-100 p-2 max-h-20 overflow-auto border rounded"></div>
            
            <button onclick="processDocxImport()" class="w-full bg-canvas-accent text-white py-2 font-bold rounded hover:bg-blue-700 transition">Process & Publish</button>
        </div>
    `); 
}

window.openAddStudentModal = () => { const s = db.subjects.find(x => x.id === currentCourseId); const avail = db.users.filter(u => u.role==='student' && !s.students.includes(u.id)); renderModal('modal-add-student', 'Enroll Existing Students', `<div class="space-y-2 max-h-64 overflow-y-auto mb-4 border p-2 rounded">${avail.map(u => `<label class="flex items-center p-2 hover:bg-gray-50 cursor-pointer"><input type="checkbox" class="student-select mr-3" value="${u.id}"><span>${u.name}</span></label>`).join('')}</div><button onclick="enrollStudents()" class="w-full bg-canvas-accent text-white py-2 rounded font-bold">Add Selected</button>`); }
window.openRegisterStudentModal = () => { renderModal('modal-reg-student', 'Create New Student Account', `<div class="space-y-3"><input id="reg-s-name" class="w-full border p-2 rounded" placeholder="Full Name"><input id="reg-s-user" class="w-full border p-2 rounded" placeholder="Username"><input id="reg-s-pass" class="w-full border p-2 rounded" placeholder="Password"><button onclick="registerStudent()" class="w-full bg-canvas-success text-white py-2 rounded font-bold">Create Account</button></div>`); }

// Logic: Feed
window.toggleMediaInput = () => { 
    const t=$('post-type').value;
    const u=$('post-url'); 
    const f=$('post-file-container');
    
    u.classList.add('hidden');
    f.classList.add('hidden');

    if(t==='text') {
        // do nothing
    } else if (t === 'image_upload') {
        f.classList.remove('hidden');
    } else { 
        u.classList.remove('hidden'); 
        u.placeholder = t==='video'?'Paste YouTube URL...':'Paste Link URL...'; 
    } 
}
window.publishPost = () => { 
    const c=$('post-content').value;
    const t=$('post-type').value;
    let u=$('post-url').value;
    
    if (t === 'image_upload') {
        if (!tempTeacherImage) return showToast('Please upload an image', 'error');
        u = tempTeacherImage;
    }

    if(c||u) { 
        if(!db.posts) db.posts=[]; 
        db.posts.push({
            id:'p'+Date.now(), 
            courseId:currentCourseId, 
            authorId:currentUser.id, 
            authorName:currentUser.name, 
            date:new Date().toISOString(), 
            content:c, 
            mediaType:t, 
            mediaUrl:u, 
            isPinned: false
        }); 
        tempTeacherImage = null; // reset
        saveDB(); 
        render(); 
    } 
}
window.editIntro = () => { 
    const s = db.subjects.find(x => x.id === currentCourseId); 
    const t = prompt('Title:', s.introTitle);
    if (t === null) return;
    const b = prompt('Body:', s.introBody);
    if(b!==null) { s.introTitle=t; s.introBody=b; saveDB(); render(); } 
}

window.enrollStudents = () => { const ids = Array.from(document.querySelectorAll('.student-select:checked')).map(cb => cb.value); const s = db.subjects.find(x => x.id === currentCourseId); if(ids.length > 0) { s.students.push(...ids); saveDB(); toggleModal('modal-add-student'); render(); showToast(`Added ${ids.length} students`); } }

// Logic: Exams (Create/Edit logic moved to window.saveExam)
window.createExam = () => { window.saveExam(); } // Fallback for any old button calls

window.downloadTemplate = () => { const t = `For items 1-2:\nPassage text...\n\n1. Question?\nA. Opt A\nB. Opt B\nAnswer: B`; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([t],{type:'text/plain'})); a.download = 'Smart_Quiz_Template.txt'; a.click(); }
document.addEventListener('change', async (e) => { if(e.target && e.target.id === 'docx-upload') { const reader = new FileReader(); reader.onload = function(evt) { mammoth.extractRawText({arrayBuffer: evt.target.result}).then(r => { importedText = r.value; $('parse-preview').classList.remove('hidden'); $('parse-preview').innerText = importedText.substring(0,300)+'...'; }); }; reader.readAsArrayBuffer(e.target.files[0]); } });

window.processDocxImport = () => { 
    const o = $('imp-open').value;
    const d = $('imp-due').value;
    const att = $('imp-attempts').value;
    const limit = $('imp-timelimit').value;

    if (!importedText || !o || !d) return showToast('Missing file or dates', 'error'); 
    
    const questions = parseQuizText(importedText); 
    
    if(questions.length > 0) { 
        if(!db.exams[currentCourseId]) db.exams[currentCourseId]=[]; 
        db.exams[currentCourseId].push({
            id: 'e'+Date.now(), 
            title: 'Imported Quiz', 
            openDate: o, 
            dueDate: d, 
            timeLimit: parseInt(limit) || 30, 
            attempts: parseInt(att) || 1, 
            category: 'ww', // Default imported to WW
            questions: questions
        }); 
        saveDB(); 
        closeModal('modal-import'); 
        render(); 
        showToast(`Imported ${questions.length} questions`); 
    } else { 
        showToast('No questions detected.', 'error'); 
    } 
}
window.showItemAnalysis = (eid) => { const ex = db.exams[currentCourseId].find(e => e.id === eid); const subs = db.examSubmissions[eid] || {}; const total = Object.keys(subs).length; let html = `<div class="grid grid-cols-2 gap-4 mb-4"><div class="bg-blue-50 p-2 text-center rounded"><span class="text-xs font-bold text-gray-500">TAKEN</span><br><span class="text-xl font-bold">${total}</span></div><div class="bg-green-50 p-2 text-center rounded"><span class="text-xs font-bold text-gray-500">AVG</span><br><span class="text-xl font-bold">${total>0?Math.round(Object.values(subs).reduce((a,b)=>a+b.score,0)/total):0}%</span></div></div><div class="space-y-2 max-h-60 overflow-y-auto">`; ex.questions.forEach((q,i) => { let correct=0; Object.values(subs).forEach(s=>{if(s.answers&&s.answers[i]===q.ans)correct++}); const pct=total>0?Math.round((correct/total)*100):0; html+=`<div class="bg-gray-50 p-2 rounded border"><p class="text-xs font-bold mb-1">Q${i+1}: ${q.q}</p><div class="flex items-center gap-2"><div class="flex-1 h-2 bg-gray-200 rounded-full"><div class="h-full ${pct>75?'bg-green-500':(pct>40?'bg-yellow-400':'bg-red-500')}" style="width:${pct}%"></div></div><span class="text-xs font-bold">${pct}%</span></div></div>`; }); html+=`</div>`; renderModal('modal-analytics', 'Item Analysis', html); }

// Updated deleteExam with Cascading Delete
window.deleteExam = (eid) => { 
    showConfirm('Delete this quiz? All student results for this quiz will also be deleted.', () => { 
        db.exams[currentCourseId] = db.exams[currentCourseId].filter(e => e.id !== eid); 
        if (db.examSubmissions[eid]) {
            delete db.examSubmissions[eid]; // Cascading Delete
        }
        saveDB(); 
        render(); 
        showToast('Quiz and results deleted', 'error');
    }); 
}

window.startExam = (eid) => { activeExamId=eid; currentView='exam-take'; render(); }
window.reviewExam = (eid) => { activeExamId=eid; currentView='exam-review'; render(); }

// Teacher Review Content (Read-Only Preview)
window.reviewExamContent = (eid) => {
    const ex = db.exams[currentCourseId].find(e => e.id === eid);
    let html = `<div class="space-y-6 max-h-[70vh] overflow-y-auto pr-2">`;
    let lastPassage = '';
    
    ex.questions.forEach((q, i) => {
        if (q.passage && q.passage !== lastPassage) {
            lastPassage = q.passage;
            html += `<div class="bg-blue-50 p-4 rounded border border-blue-100 text-gray-800 text-sm italic font-serif leading-relaxed">${q.passage.replace(/\n/g, '<br>')}</div>`;
        } else if (!q.passage) lastPassage = '';

        html += `
            <div class="bg-gray-50 p-4 rounded border border-gray-200">
                <p class="font-bold text-gray-800 mb-2">${i+1}. ${q.q}</p>
                <div class="space-y-1 ml-4">
                    ${q.options.map((o, oi) => {
                        const isCorrect = oi === q.ans;
                        return `<div class="${isCorrect ? 'text-green-700 font-bold' : 'text-gray-600'} flex items-center gap-2">
                            <span>${String.fromCharCode(65+oi)}.</span> ${o} ${isCorrect ? '<i class="fas fa-check"></i>' : ''}
                        </div>`;
                    }).join('')}
                </div>
            </div>
        `;
    });
    html += `</div>`;
    renderModal('modal-review-content', `Reviewing: ${ex.title}`, html);
}

window.renderExamTake = (c) => { const s = db.subjects.find(x => x.id === currentCourseId); const ex = db.exams[s.id].find(e => e.id === activeExamId); let mins=parseInt(ex.timeLimit||30), secs=0; let lastPassage = ''; c.innerHTML = `<div class="max-w-4xl mx-auto bg-white min-h-screen border-x border-gray-200"><div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10 shadow-sm"><h1 class="text-2xl font-bold text-gray-800">${ex.title}</h1><div class="text-xl font-mono font-bold text-red-600" id="timer">--:--</div></div><div class="p-8 space-y-8">${ex.questions.map((q,i) => { let passageHtml = ''; if (q.passage && q.passage !== lastPassage) { lastPassage = q.passage; passageHtml = `<div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-gray-800 mb-6 font-serif leading-relaxed whitespace-pre-line">${q.passage}</div>`; } else if (!q.passage) { lastPassage = ''; } return `${passageHtml}<div class="bg-gray-50 p-6 rounded border border-gray-200"><p class="text-lg font-medium mb-4"><span class="font-bold text-gray-400 mr-2">${i+1}.</span>${q.q}</p><div class="space-y-2">${q.options.map((o,oi)=>`<label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-blue-50 transition"><input type="radio" name="q${i}" value="${oi}" class="mr-3 w-4 h-4 text-canvas-accent"><span>${o}</span></label>`).join('')}</div></div>`; }).join('')}</div><div class="p-6 border-t bg-gray-50 flex justify-end gap-4 sticky bottom-0 shadow-inner"><button onclick="render()" class="text-gray-500 font-bold hover:text-gray-700">Cancel</button><button onclick="submitExam()" class="bg-canvas-accent text-white px-8 py-2 rounded font-bold shadow hover:bg-blue-700 transition">Submit Quiz</button></div></div>`; const int = setInterval(() => { if(!$('timer')) { clearInterval(int); return; } if(secs===0) { if(mins===0) { clearInterval(int); submitExam(); return; } mins--; secs=59; } else secs--; $('timer').innerText=`${mins}:${secs<10?'0':''}${secs}`; }, 1000); }
window.renderExamReview = (c) => { const s = db.subjects.find(x => x.id === currentCourseId); const ex = db.exams[s.id].find(e => e.id === activeExamId); const sub = db.examSubmissions[activeExamId][currentUser.id]; let lastPassage = ''; c.innerHTML = `<div class="max-w-4xl mx-auto bg-white min-h-screen border-x border-gray-200"><div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10 shadow-sm bg-green-50"><div><h1 class="text-2xl font-bold text-gray-800">${ex.title} (Review)</h1><p class="text-sm text-gray-600">Final Score: <span class="font-bold text-lg">${sub.score}%</span></p></div><button onclick="render()" class="text-gray-500 font-bold hover:text-gray-700">Close Review</button></div><div class="p-8 space-y-8">${ex.questions.map((q,i) => { let passageHtml = ''; if (q.passage && q.passage !== lastPassage) { lastPassage = q.passage; passageHtml = `<div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-gray-800 mb-6 font-serif leading-relaxed whitespace-pre-line">${q.passage}</div>`; } else if (!q.passage) { lastPassage = ''; } const userAns = (sub.answers && sub.answers[i] !== undefined) ? sub.answers[i] : -1; const isSkipped = userAns === -1; const isCorrect = userAns === q.ans; let statusHtml = isSkipped ? '<span class="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-1 rounded ml-2">Not Answered</span>' : (isCorrect ? '<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded ml-2">Correct</span>' : '<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded ml-2">Incorrect</span>'); let borderClass = isSkipped ? 'border-amber-300 bg-amber-50/20' : (isCorrect ? 'border-green-300 bg-green-50/20' : 'border-red-300 bg-red-50/20'); return `${passageHtml}<div class="bg-white p-6 rounded border ${borderClass}"><p class="text-lg font-medium mb-4"><span class="font-bold text-gray-400 mr-2">${i+1}.</span>${q.q} ${statusHtml}</p><div class="space-y-2">${q.options.map((o,oi)=> { let cls = "border-gray-200"; let icon = ""; if (oi === q.ans) { cls = "border-green-500 bg-green-100 font-bold"; icon = '<div class="ml-auto flex items-center text-green-700 text-xs font-bold"><i class="fas fa-check mr-1"></i> Correct Answer</div>'; } else if (oi === userAns && !isCorrect) { cls = "border-red-500 bg-red-100"; icon = '<div class="ml-auto flex items-center text-red-700 text-xs font-bold"><i class="fas fa-times mr-1"></i> Your Answer</div>'; } return `<div class="flex items-center p-3 border rounded ${cls}"><span class="mr-3 font-mono">${String.fromCharCode(65+oi)}.</span><span class="flex-1">${o}</span>${icon}</div>` }).join('')}</div></div>`; }).join('')}</div></div>`; }
window.submitExam = () => { const ex=db.exams[currentCourseId].find(e=>e.id===activeExamId), ans=[]; let score=0; ex.questions.forEach((q,i) => { const s=document.querySelector(`input[name="q${i}"]:checked`); const v=s?parseInt(s.value):-1; ans.push(v); if(v===q.ans)score++; }); const p=Math.round((score/ex.questions.length)*100); if(!db.examSubmissions[activeExamId]) db.examSubmissions[activeExamId]={}; const prev = db.examSubmissions[activeExamId][currentUser.id]; const attemptCount = prev ? (prev.attemptsTaken || 0) + 1 : 1; db.examSubmissions[activeExamId][currentUser.id] = { score: p, answers: ans, attemptsTaken: attemptCount }; saveDB(); showToast(`Submitted! Score: ${p}%`); if(attemptCount >= (ex.attempts || 1)) { reviewExam(activeExamId); } else { currentView='course'; currentTab='quizzes'; render(); } }
window.toggleModal = (id) => { if($(id)){ $(id).remove(); return; } }
window.closeModal = (id) => { const el = document.getElementById(id); if (el) el.remove(); } 
window.renderModal = (id,t,h) => { if($(id)) $(id).remove(); $('modal-portal').innerHTML=`<div id="${id}" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm"><div class="bg-white p-6 rounded w-96 max-h-[90vh] overflow-y-auto shadow-2xl"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg">${t}</h3><button onclick="closeModal('${id}')"><i class="fas fa-times"></i></button></div>${h}</div></div>`; }

render();
</script>
</body>

</html>

